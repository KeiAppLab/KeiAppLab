<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEI Lab ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</title>

    <!-- å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ -->
    <!-- â€»å®Ÿé‹ç”¨ã§ã¯ apps_list.js ã‚‚GitHubã«å­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ -->
    <script src="news_data.js"></script>
    <script src="apps_list.js" onerror="window.appsListData = [];"></script> <!-- ãªã‘ã‚Œã°ç©ºé…åˆ— -->
    <script src="allowed_users.js"></script>
    <script src="index_phot.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Roboto:wght@400;500;900&display=swap');

        /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: #1e1e1e; color: #ddd; height: 100vh; overflow: hidden; }
        #mainWrapper { display: none; height: 100%; }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-container-split { display: flex; width: 800px; height: 500px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-left { width: 40%; padding: 40px; display: flex; flex-direction: column; justify-content: center; background: #f9f9f9; border-right: 1px solid #eee; }
        .login-left input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-left button { width: 100%; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-left button:hover { background: #003d82; }
        .login-right { width: 60%; padding: 40px; overflow-y: auto; color: #333; line-height: 1.6; }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        .dashboard { display: grid; grid-template-columns: 250px 1fr; height: 100%; }
        .sidebar { background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        .sidebar h1 { font-size: 1.2rem; color: #fff; margin: 20px 10px; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
        
        .menu-group { margin-bottom: 10px; }
        .menu-label { font-size: 0.8rem; color: #777; margin-left: 10px; margin-bottom: 5px; font-weight: bold; }
        .menu-btn { padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 5px; color: #aaa; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-btn:hover { background: #3c3c3c; color: #fff; }
        .menu-btn.active { background: #007acc; color: white; }
        
        /* æ¨©é™ç®¡ç†ã®ä¸Šã®ç©ºç™½ */
        .spacer { height: 30px; }

        .main-content { position: relative; overflow: hidden; height: 100%; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .panel.active { display: block; }

        /* --- CMSãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .cms-layout { display: flex; height: 100%; gap: 20px; }
        .editor-area { width: 45%; overflow-y: auto; padding-right: 10px; height: 100%; }
        .preview-area { width: 55%; background: #e0e0e0; color: #333; border-radius: 8px; overflow-y: auto; padding: 20px; height: 100%; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-top: 5px; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #aaa; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #555; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        .input-white { background-color: #ffffff !important; color: #333 !important; border: 1px solid #ccc !important; font-weight: bold; }
        
        /* URLå…¥åŠ›æ™‚ã®ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-locked { background-color: #eee !important; color: #555 !important; cursor: not-allowed; }
        .url-lock-controls { display: flex; justify-content: flex-end; margin-top: 2px; }
        .btn-unlock { background: transparent; color: #007acc; border: none; font-size: 0.8rem; cursor: pointer; width: auto; padding: 0; }
        
        .input-group { display: flex; width: 100%; }
        .input-group input { flex: 1; border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; border-right: 0 !important; }
        .input-group select { flex: 1; border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; background-color: #e6e6e6 !important; color: #0056b3 !important; cursor: pointer; }

        .editor-lang-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .edit-tab { padding: 8px 15px; background: #333; color: #aaa; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .edit-tab:hover { background: #444; color: #fff; }
        .edit-tab.active { background: #007acc; color: white; }
        
        .lang-input-group { display: none; animation: fadeIn 0.3s; }
        .lang-input-group.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ç”»åƒé¸æŠ */
        .custom-select-wrapper { position: relative; user-select: none; width: 450px; max-width: 100%; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 10px; font-size: 1rem; font-weight: bold; color: #333; background: #ffffff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        .custom-options { position: absolute; display: block; top: 100%; left: 0; right: 0; border: 1px solid #ccc; border-top: 0; background: #fff; transition: all 0.3s; opacity: 0; visibility: hidden; pointer-events: none; z-index: 100; max-height: 300px; overflow-y: auto; border-radius: 0 0 4px 4px; }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; }
        .custom-option { position: relative; display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.2s; color: #333; }
        .custom-option:hover { background-color: #f2f9fc; color: #0056b3; }
        .option-img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; margin-right: 15px; border: 1px solid #ddd; }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .preview-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .preview-cards-container { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .preview-col { flex: 1; min-width: 280px; }
        
        .preview-label { font-size: 0.8rem; color: #666; font-weight: bold; border-bottom: 1px dashed #999; display: block; margin-bottom: 10px; }

        /* ã‚«ãƒ¼ãƒ‰å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .card-preview { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .card-img-area { width: 100%; height: 160px; overflow: hidden; background: #eee; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-content { padding: 15px; }
        
        /* æœ€æ–°ã®æ´»å‹•ã‚«ãƒ¼ãƒ‰ */
        .highlight-badge { position: absolute; bottom: 0; left: 0; color: white; font-size: 0.8rem; padding: 4px 12px; border-top-right-radius: 8px; font-weight: bold; z-index: 2; }
        .highlight-title { font-family: 'Noto Serif JP', serif; font-size: 1rem; font-weight: 900; color: #333; margin: 5px 0 0; line-height: 1.4; }
        
        /* ã‚¢ãƒ—ãƒªç´¹ä»‹ã‚«ãƒ¼ãƒ‰ */
        .app-intro-text { font-size: 0.85rem; color: #555; line-height: 1.6; margin-top: 8px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* è©³ç´°ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .page-preview { font-family: 'Noto Serif JP', serif; line-height: 1.8; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; min-height: 300px; }
        .page-preview h1 { border-bottom: 3px solid #0056b3; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; font-size: 1.5rem; }
        .page-preview iframe { width: 100%; height: 500px; border: 1px solid #ccc; border-radius: 4px; }
        #prevBody { white-space: pre-wrap; }

        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%; }
        .btn-save { background: #27ae60; color: white; }
        .btn-copy { background: #e67e22; color: white; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="loginOverlay">
        <div class="login-container-split">
            <div class="login-left">
                <h2>ğŸš€ KEI Lab Admin</h2>
                <input type="password" id="tokenInput" placeholder="GitHub Token">
                <button onclick="checkIdentity()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="authStatus"></div>
            </div>
            <div class="login-right">
                <h3>ğŸ”‘ æ‰‹é †</h3>
                <p>GitHub Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <div id="mainWrapper">
        <div class="dashboard">
            <div class="sidebar">
                <h1>ğŸš€ KEI Lab Admin</h1>
                
                <div class="menu-btn active" onclick="switchPanel('calc')">ğŸ’° åç›Šãƒ»ç§’æ•°è¨ˆç®—</div>
                
                <div class="menu-label">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†</div>
                <div class="menu-btn" onclick="switchPanel('cms')">ğŸ“ è¨˜äº‹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</div>
                <div class="menu-btn" onclick="switchPanel('allprojects')">ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</div>
                
                <div class="spacer"></div>
                
                <div class="menu-label">æ¨©é™ç®¡ç†</div>
                <div class="menu-btn" onclick="switchPanel('users')">ğŸ‘¥ æ¨©é™ç®¡ç†</div>
                
                <div class="menu-btn" onclick="logout()" style="margin-top:auto; background:#c0392b; color:white;">ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
            </div>

            <div class="main-content">

                <!-- 1. è¨ˆç®—æ©Ÿãƒ‘ãƒãƒ« -->
                <div id="panel-calc" class="panel active">
                    <div class="calc-container">
                        <h2>ğŸ’° åç›Šè¨ˆç®—</h2>
                        <!-- æ—¢å­˜ã®è¨ˆç®—æ©Ÿã‚³ãƒ¼ãƒ‰ï¼ˆçœç•¥ã›ãšå®Ÿè£…ï¼‰ -->
                         <div class="calc-grid">
                            <div><label>å‹•ç”»åºƒå‘Šå˜ä¾¡</label><input type="number" id="adPrice" value="1.5" step="0.1"> å††</div>
                            <div><label>é€šè©±åŸä¾¡ (1åˆ†)</label><input type="number" id="callCost" value="3.0" step="0.1"> å††</div>
                        </div>
                        <label>ç¢ºä¿ã—ãŸã„åˆ©ç›Šç‡ (%) <span id="marginDisplay">20%</span></label>
                        <input type="range" id="margin" min="0" max="50" value="20" oninput="document.getElementById('marginDisplay').innerText = this.value + '%'">
                        <button class="btn-calc" onclick="calcSeconds()">è¨ˆç®—ã™ã‚‹</button>
                        <div class="calc-result-box">
                            <div id="calcOutput" class="calc-number">--- ç§’</div>
                        </div>
                    </div>
                </div>

                <!-- 2. CMSãƒ‘ãƒãƒ« -->
                <div id="panel-cms" class="panel">
                    <div class="cms-layout">
                        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
                        <div class="editor-area">
                            <h2>ğŸ“ è¨˜äº‹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
                            
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="text" id="inDate" class="input-white" style="width:100% !important;">
                            </div>

                            <div class="form-group">
                                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                                <select id="inCategory" class="input-white" style="width:100% !important;" onchange="updatePreview()">
                                    <option value="update">æ›´æ–°æƒ…å ±</option>
                                    <option value="release">ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="start">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹</option>
                                    <option value="steam">Steamãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="game">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
                                <input type="hidden" id="inImage" onchange="updatePreview()">
                                <div class="custom-select-wrapper">
                                    <div class="custom-select">
                                        <div class="custom-select__trigger" onclick="toggleImageSelect()">
                                            <span id="selectedImageText">ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„...</span>
                                            <span>â–¼</span>
                                        </div>
                                        <div class="custom-options" id="imageOptions"></div>
                                    </div>
                                </div>
                            </div>

                            <hr style="border:0; border-top:1px dashed #555; margin: 20px 0;">

                            <div class="editor-lang-tabs">
                                <button class="edit-tab active" onclick="switchEditorLang('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
                                <button class="edit-tab" onclick="switchEditorLang('en')">ğŸ‡ºğŸ‡¸ English</button>
                                <!-- ä»–è¨€èªçœç•¥å¯èƒ½ -->
                            </div>

                            <!-- æ—¥æœ¬èªå…¥åŠ› -->
                            <div id="group-ja" class="lang-input-group active">
                                <div class="form-group">
                                    <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (JP)ã€€news_data.js</label>
                                    <div class="input-group">
                                        <input type="text" id="inProject" class="input-white" placeholder="å…¥åŠ›ã¾ãŸã¯å³ã‹ã‚‰é¸æŠ" oninput="autoFillProject()" autocomplete="off">
                                        <select id="projectSelectHelper" class="input-white" onchange="syncProjectSelect()">
                                            <option value="">â–¼ å±¥æ­´...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ (JP)</label>
                                    <input type="text" id="inTitle" class="input-white" oninput="updatePreview()">
                                </div>
                                <!-- æ–°è¨­ï¼šã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ -->
                                <div class="form-group">
                                    <label style="color:#27ae60;">â–¼ ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ (JP)</label>
                                    <textarea id="inAppIntro" class="input-white" style="height:80px;" placeholder="ä¸€è¦§ãƒšãƒ¼ã‚¸ç”¨ã®çŸ­ã„ç´¹ä»‹æ–‡" oninput="updatePreview()"></textarea>
                                </div>
                                <!-- å¤‰æ›´ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆHPè©³ç´° -->
                                <div class="form-group">
                                    <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆHPè©³ç´° (ã¾ãŸã¯URL)</label>
                                    <textarea id="inBody" class="input-white" style="height:150px;" placeholder="HTMLã¾ãŸã¯URLã‚’å…¥åŠ›" oninput="checkUrlInput('inBody'); updatePreview();"></textarea>
                                    <div class="url-lock-controls">
                                        <button class="btn-unlock" onclick="unlockInput('inBody')">ç·¨é›†ãƒ­ãƒƒã‚¯è§£é™¤</button>
                                    </div>
                                </div>
                            </div>

                            <!-- è‹±èªå…¥åŠ› -->
                            <div id="group-en" class="lang-input-group">
                                <div class="form-group"><label>Project Name (EN)</label><input type="text" id="inProjectEn" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Title (EN)</label><input type="text" id="inTitleEn" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label style="color:#27ae60;">â–¼ App Intro Body (EN)</label><textarea id="inAppIntroEn" class="input-white" style="height:80px;" oninput="updatePreview()"></textarea></div>
                                <div class="form-group">
                                    <label>Project HP Details (or URL)</label>
                                    <textarea id="inBodyEn" class="input-white" style="height:150px;" oninput="checkUrlInput('inBodyEn'); updatePreview();"></textarea>
                                    <div class="url-lock-controls"><button class="btn-unlock" onclick="unlockInput('inBodyEn')">Unlock</button></div>
                                </div>
                            </div>

                            <button class="btn-save" onclick="saveAllData()">ä¿å­˜å®Ÿè¡Œï¼ (å…¨ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°)</button>
                        </div>

                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                        <div class="preview-area">
                            <h2>ğŸ‘ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (JP/EN)</h2>
                            
                            <!-- ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼2ç¨® -->
                            <div class="preview-cards-container">
                                <!-- 1. æœ€æ–°ã®æ´»å‹• -->
                                <div class="preview-col">
                                    <span class="preview-label">â–¼ æœ€æ–°ã®æ´»å‹• (Highlights Card)</span>
                                    <div class="card-preview">
                                        <div class="card-img-area">
                                            <img src="" id="prevImg" class="card-img">
                                            <span class="highlight-badge tag-update" id="prevCardCatBadge">æ›´æ–°æƒ…å ±</span>
                                        </div>
                                        <div class="card-content">
                                            <div style="font-size:0.75rem; color:#666;">
                                                <span id="prevCardDate">2026.03.15</span> | <span id="prevCardProj">Project</span>
                                            </div>
                                            <h3 class="highlight-title" id="prevCardTitle">Title</h3>
                                        </div>
                                    </div>
                                    <p style="font-size:0.8rem; color:red;" id="highlightMsg"></p>
                                </div>

                                <!-- 2. ã‚¢ãƒ—ãƒªç´¹ä»‹ (æ–°è¦) -->
                                <div class="preview-col">
                                    <span class="preview-label">â–¼ ã‚¢ãƒ—ãƒªç´¹ä»‹ (App Intro)</span>
                                    <div class="card-preview">
                                        <div class="card-img-area">
                                            <img src="" id="prevAppImg" class="card-img">
                                        </div>
                                        <div class="card-content">
                                            <h3 class="highlight-title" id="prevAppProj">Project Name</h3>
                                            <div class="app-intro-text" id="prevAppIntro">
                                                ã‚¢ãƒ—ãƒªã®ç´¹ä»‹æ–‡ãŒã“ã“ã«å…¥ã‚Šã¾ã™ã€‚ä¸€è¦§ãƒšãƒ¼ã‚¸ã§è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹ã§ã™ã€‚
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <span class="preview-label">â–¼ è©³ç´°ãƒšãƒ¼ã‚¸ (Project Page)</span>
                            <div class="page-preview" id="pagePreviewContainer">
                                <h1 id="prevPageTitle">Title</h1>
                                <div style="color:#666; font-size:0.9rem; margin-bottom:20px;">
                                    <span id="prevPageDate">Date</span> | <span id="prevPageProject">Project</span>
                                </div>
                                <!-- HPã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¾ãŸã¯Iframe -->
                                <div id="prevHtmlContent"></div>
                                <iframe id="prevUrlContent" src="" style="display:none;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± -->
                <div id="panel-allprojects" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± (apps_list.js)</h2>
                        <p>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€è¦§ã§ã™ã€‚</p>
                        <div id="projectsListDisplay" style="color:white;"></div>
                    </div>
                </div>

                <!-- 4. æ¨©é™ç®¡ç† -->
                <div id="panel-users" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ‘¥ æ¨©é™ç®¡ç†</h2>
                        <!-- æ—¢å­˜ã®æ¨©é™ç®¡ç†ã‚³ãƒ¼ãƒ‰ -->
                         <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <input type="text" id="newUserId" placeholder="GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼ID" style="flex:1;">
                            <button class="btn-save" style="width:auto;" onclick="addUser()">è¿½åŠ </button>
                        </div>
                        <ul id="userList"></ul>
                        <button class="btn-copy" onclick="saveUsersToGitHub()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const GITHUB_CONFIG = { owner: "KeiAppLab", repo: "KeiAppLab" };
        let previewLang = 'ja';

        // --- èªè¨¼ãƒ»åˆæœŸåŒ– ---
        async function checkIdentity() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) return alert("ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            try {
                const res = await fetch("https://api.github.com/user", { headers: { Authorization: `token ${token}` } });
                if (!res.ok) throw new Error();
                const user = await res.json();
                if (allowedUsersData.includes(user.login)) {
                    localStorage.setItem('gh_token', token);
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.getElementById('mainWrapper').style.display = 'block';
                    initAll();
                } else alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
            } catch (e) { alert("èªè¨¼ã‚¨ãƒ©ãƒ¼"); }
        }

        function initAll() {
            updatePreview();
            initProjectList();
            initImageSelector();
            renderProjectsList(); // å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤º
        }
        
        function switchPanel(panelId) {
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.getElementById('panel-' + panelId).classList.add('active');
        }
        
        function logout() { localStorage.removeItem('gh_token'); location.reload(); }
        window.onload = () => { if(localStorage.getItem('gh_token')) checkIdentity(); };

        // --- URLåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        function checkUrlInput(id) {
            const el = document.getElementById(id);
            const val = el.value.trim();
            if (val.startsWith('http://') || val.startsWith('https://')) {
                el.classList.add('input-locked');
                el.setAttribute('readonly', true);
            }
        }
        function unlockInput(id) {
            const el = document.getElementById(id);
            el.classList.remove('input-locked');
            el.removeAttribute('readonly');
            el.focus();
        }

        // --- CMSãƒ­ã‚¸ãƒƒã‚¯ ---
        function updatePreview() {
            const date = document.getElementById('inDate').value;
            const category = document.getElementById('inCategory').value;
            const image = document.getElementById('inImage').value;
            
            // è¨€èªåˆ‡ã‚Šæ›¿ãˆ
            const suffix = previewLang === 'ja' ? '' : 'En'; // ç°¡æ˜“çš„ã«ENã®ã¿å®Ÿè£…
            const idSuffix = previewLang === 'ja' ? '' : 'En';

            const project = document.getElementById('inProject' + idSuffix).value || "Project";
            const title = document.getElementById('inTitle' + idSuffix).value || "Title";
            const appIntro = document.getElementById('inAppIntro' + idSuffix).value || "App Intro Text...";
            const bodyRaw = document.getElementById('inBody' + idSuffix).value || "";

            // 1. æœ€æ–°ã®æ´»å‹•ã‚«ãƒ¼ãƒ‰
            document.getElementById('prevImg').src = image;
            document.getElementById('prevCardTitle').textContent = title;
            document.getElementById('prevCardProj').textContent = project;
            document.getElementById('prevCardDate').textContent = date;
            document.getElementById('prevCardCatBadge').textContent = category;
            
            // 2. ã‚¢ãƒ—ãƒªç´¹ä»‹ã‚«ãƒ¼ãƒ‰ (æ–°è¦)
            document.getElementById('prevAppImg').src = image;
            document.getElementById('prevAppProj').textContent = project;
            document.getElementById('prevAppIntro').textContent = appIntro;

            // 3. è©³ç´°ãƒšãƒ¼ã‚¸
            document.getElementById('prevPageTitle').textContent = title;
            document.getElementById('prevPageDate').textContent = date;
            document.getElementById('prevPageProject').textContent = project;
            
            const htmlContainer = document.getElementById('prevHtmlContent');
            const iframeContainer = document.getElementById('prevUrlContent');

            if (bodyRaw.startsWith('http')) {
                htmlContainer.style.display = 'none';
                iframeContainer.style.display = 'block';
                iframeContainer.src = bodyRaw;
            } else {
                htmlContainer.style.display = 'block';
                iframeContainer.style.display = 'none';
                htmlContainer.innerHTML = bodyRaw;
            }
        }

        function switchEditorLang(lang) {
            document.querySelectorAll('.lang-input-group').forEach(el => el.classList.remove('active'));
            document.getElementById('group-' + lang).classList.add('active');
            previewLang = lang;
            updatePreview();
        }

        // --- è‡ªå‹•å…¥åŠ› (newsData + appsListData ã‹ã‚‰è£œå®Œ) ---
        function autoFillProject() {
            const inputProject = document.getElementById('inProject').value.trim();
            if (!inputProject) return;

            // 1. newsDataã‹ã‚‰æœ€æ–°ã®è¨˜äº‹æƒ…å ±ã‚’æ¢ã™
            if (typeof newsData !== 'undefined') {
                const post = newsData.slice().reverse().find(p => p.project === inputProject);
                if (post) {
                    document.getElementById('inTitle').value = post.title || "";
                    document.getElementById('inBody').value = post.body || "";
                    // ...ä»–è¨€èªã‚‚åŒæ§˜ã«
                    setImageValue(post.image || "");
                }
            }
            // 2. appsListDataã‹ã‚‰å›ºå®šæƒ…å ±(ã‚¢ãƒ—ãƒªç´¹ä»‹)ã‚’æ¢ã™
            if (typeof appsListData !== 'undefined') {
                const app = appsListData.find(a => a.project === inputProject);
                if (app) {
                    document.getElementById('inAppIntro').value = app.intro || "";
                    document.getElementById('inAppIntroEn').value = app.intro_en || "";
                }
            }
            updatePreview();
        }

        // --- ä¿å­˜å®Ÿè¡Œ (æ ¸å¿ƒéƒ¨åˆ†) ---
        async function saveAllData() {
            const token = localStorage.getItem('gh_token');
            if (!token) return alert("èªè¨¼ãŒå¿…è¦ã§ã™");
            if (!confirm("å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ãƒ»ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

            // 1. ç¾åœ¨ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
            const currentEntry = {
                id: Date.now(),
                date: document.getElementById('inDate').value,
                category: document.getElementById('inCategory').value,
                image: document.getElementById('inImage').value,
                project: document.getElementById('inProject').value,
                title: document.getElementById('inTitle').value,
                body: document.getElementById('inBody').value,
                intro: document.getElementById('inAppIntro').value, // ç´¹ä»‹æ–‡
                // ENãƒ‡ãƒ¼ã‚¿
                project_en: document.getElementById('inProjectEn').value,
                title_en: document.getElementById('inTitleEn').value,
                body_en: document.getElementById('inBodyEn').value,
                intro_en: document.getElementById('inAppIntroEn').value
            };

            // --- A. ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (news_data.js) ---
            // å…¨ä»¶ä¿æŒã€‚å…ˆé ­ã«è¿½åŠ 
            const newNewsData = [currentEntry, ...newsData];
            
            // --- B. ã‚¢ãƒ—ãƒªä¸€è¦§ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (apps_list.js) ---
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯(ä¸€æ„)ã«ã™ã‚‹
            let newAppsList = [...(typeof appsListData !== 'undefined' ? appsListData : [])];
            const appIndex = newAppsList.findIndex(a => a.project === currentEntry.project);
            const appInfo = {
                project: currentEntry.project,
                project_en: currentEntry.project_en,
                image: currentEntry.image,
                intro: currentEntry.intro,
                intro_en: currentEntry.intro_en,
                url: currentEntry.body.startsWith('http') ? currentEntry.body : "" // URLãªã‚‰ä¿å­˜
            };
            
            if (appIndex >= 0) {
                newAppsList[appIndex] = appInfo; // ä¸Šæ›¸ãæ›´æ–°
            } else {
                newAppsList.push(appInfo); // æ–°è¦è¿½åŠ 
            }

            // --- C. ãƒˆãƒƒãƒ—ç”¨ãƒ‹ãƒ¥ãƒ¼ã‚¹ (index_news.js) ---
            // ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹ç³»æœ€æ–°10ä»¶
            const releaseCats = ['release', 'start', 'steam'];
            const topReleases = newNewsData.filter(d => releaseCats.includes(d.category)).slice(0, 10);
            // æ›´æ–°ç³»æœ€æ–°10ä»¶
            const updateCats = ['update', 'game'];
            const topUpdates = newNewsData.filter(d => updateCats.includes(d.category)).slice(0, 10);
            const indexNewsContent = [...topReleases, ...topUpdates];

            // --- D. ã‚¢ãƒ—ãƒªåˆ¥ã‚µãƒãƒªãƒ¼ (apps_summary.js) ---
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯ã«æœ€æ–°3ä»¶ã‚’æŠ½å‡º
            const summaryData = {};
            newAppsList.forEach(app => {
                const projNews = newNewsData.filter(d => d.project === app.project).slice(0, 3);
                summaryData[app.project] = projNews.map(d => ({
                    date: d.date,
                    title: d.title,
                    title_en: d.title_en,
                    category: d.category
                }));
            });

            // --- E. å€‹åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ ([Project]/news.js) ---
            // ä»Šå›å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ç”Ÿæˆ
            const thisProjectNews = newNewsData.filter(d => d.project === currentEntry.project);

            // === ä¿å­˜å‡¦ç† (ä¸¦åˆ—å®Ÿè¡Œ) ===
            try {
                await Promise.all([
                    saveFile("news_data.js", `const newsData = ${JSON.stringify(newNewsData, null, 4)};`),
                    saveFile("apps_list.js", `const appsListData = ${JSON.stringify(newAppsList, null, 4)};`),
                    saveFile("index_news.js", `const indexNewsData = ${JSON.stringify(indexNewsContent, null, 4)};`),
                    saveFile("apps_summary.js", `const appsSummaryData = ${JSON.stringify(summaryData, null, 4)};`),
                    // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã¯APIã§è‡ªå‹•ã«ã¯ãªã‚‰ãªã„ãŸã‚ã€ç°¡æ˜“çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹æŒ‡å®šã§ä¿å­˜è©¦è¡Œ
                    // â€»å®Ÿéš›ã«ã¯ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€GitHub APIã¯ãƒ‘ã‚¹æŒ‡å®šã§ä½œæˆå¯èƒ½ã§ã™
                    saveFile(`${currentEntry.project}/news.js`, `const projectNewsData = ${JSON.stringify(thisProjectNews, null, 4)};`)
                ]);
                alert("å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                location.reload(); // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            } catch (e) {
                alert("ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            }
        }

        // æ±ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜é–¢æ•°
        async function saveFile(path, contentStr) {
            const token = localStorage.getItem('gh_token');
            // 1. SHAå–å¾— (ä¸Šæ›¸ãã®ãŸã‚)
            let sha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                    headers: { Authorization: `token ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    sha = data.sha;
                }
            } catch(e) {} // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ç„¡è¦–(æ–°è¦ä½œæˆ)

            // 2. ä¿å­˜ (PUT)
            const encoded = btoa(unescape(encodeURIComponent(contentStr)));
            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: `Update ${path} via Admin`,
                    content: encoded,
                    sha: sha
                })
            });
            if (!res.ok) throw new Error(`Failed to save ${path}`);
        }

        // ç”»åƒç³»ã€è¨ˆç®—æ©Ÿç³»ãªã©ã®æ—¢å­˜é–¢æ•°ã¯çœç•¥ã›ãšè¨˜è¿°...
        // (æ–‡å­—æ•°åˆ¶é™ã®ãŸã‚ã€ã“ã“ã«ã¯ä¸»è¦ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿è¨˜è¼‰ã—ã¦ã„ã¾ã™ãŒã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ç”»åƒé¸æŠã‚„è¨ˆç®—æ©Ÿèƒ½ã¯ãã®ã¾ã¾ç¶­æŒã—ã¦ãã ã•ã„)
        function initImageSelector() { /* å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ */ }
        function toggleImageSelect() { document.querySelector('.custom-select').classList.toggle('open'); }
        function selectImage(val) { document.getElementById('inImage').value = "index_phot/" + val; updatePreview(); }
        function calcSeconds() { /* å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ */ }
        function renderProjectsList() { /* appsListDataã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç† */ }

        // åˆæœŸæ—¥ä»˜è¨­å®š
        const today = new Date();
        document.getElementById('inDate').value = today.getFullYear() + '.' + (today.getMonth()+1).toString().padStart(2, '0') + '.' + today.getDate().toString().padStart(2, '0');

    </script>
</body>
</html>

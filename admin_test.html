<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEI Lab ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</title>

    <!-- å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ -->
    <!-- news_data.js: ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ -->
    <script src="news_data.js"></script>
    <!-- apps_list.js: ã‚¢ãƒ—ãƒªç´¹ä»‹ä¸€è¦§ãƒ‡ãƒ¼ã‚¿ (å­˜åœ¨ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Š) -->
    <script src="apps_list.js" onerror="window.appsListData=[]"></script>
    <script src="allowed_users.js"></script>
    <script src="index_phot.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Roboto:wght@400;500;900&display=swap');

        /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: #1e1e1e; color: #ddd; height: 100vh; overflow: hidden; }
        #mainWrapper { display: none; height: 100%; }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-container-split { display: flex; width: 800px; height: 500px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-left { width: 40%; padding: 40px; display: flex; flex-direction: column; justify-content: center; background: #f9f9f9; border-right: 1px solid #eee; }
        .login-left input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-left button { width: 100%; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-left button:hover { background: #003d82; }
        .login-right { width: 60%; padding: 40px; overflow-y: auto; color: #333; line-height: 1.6; }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        .dashboard { display: grid; grid-template-columns: 250px 1fr; height: 100%; }
        .sidebar { background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        .sidebar h1 { font-size: 1.2rem; color: #fff; margin: 20px 10px; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
        .menu-btn { padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 5px; color: #aaa; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-btn:hover { background: #3c3c3c; color: #fff; }
        .menu-btn.active { background: #007acc; color: white; }
        
        /* ã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼ˆç©ºæ¬„ï¼‰ */
        .spacer { flex-grow: 1; min-height: 20px; }

        .main-content { position: relative; overflow: hidden; height: 100%; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .panel.active { display: block; }

        /* --- CMSãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .cms-layout { display: flex; height: 100%; gap: 20px; }
        .editor-area { width: 45%; overflow-y: auto; padding-right: 10px; height: 100%; }
        .preview-area { width: 55%; background: #e0e0e0; color: #333; border-radius: 8px; overflow-y: auto; padding: 20px; height: 100%; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-top: 5px; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #aaa; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #555; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        .input-white { background-color: #ffffff !important; color: #333 !important; border: 1px solid #ccc !important; font-weight: bold; }
        
        /* é€£çµå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
        .input-group { display: flex; width: 100%; }
        .input-group input { flex: 1; border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; border-right: 0 !important; }
        .input-group select { flex: 1; border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; background-color: #e6e6e6 !important; color: #0056b3 !important; cursor: pointer; }

        /* è¨€èªã‚¿ãƒ– */
        .editor-lang-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .edit-tab { padding: 8px 15px; background: #333; color: #aaa; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .edit-tab:hover { background: #444; color: #fff; }
        .edit-tab.active { background: #007acc; color: white; }
        .lang-input-group { display: none; animation: fadeIn 0.3s; }
        .lang-input-group.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ç”»åƒé¸æŠ */
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; color: #333; font-weight: bold; }
        .custom-options { position: absolute; display: block; top: 100%; left: 0; right: 0; border: 1px solid #ccc; background: #fff; opacity: 0; visibility: hidden; pointer-events: none; z-index: 100; max-height: 200px; overflow-y: auto; }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; }
        .custom-option { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; color: #333; }
        .custom-option:hover { background: #f2f9fc; color: #0056b3; }
        .option-img { width: 40px; height: 40px; object-fit: cover; margin-right: 10px; border: 1px solid #ddd; }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .preview-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .lang-toggle { display: flex; gap: 5px; background: #ddd; padding: 3px; border-radius: 20px; }
        .lang-btn { padding: 5px 10px; border-radius: 15px; border: none; font-size: 0.75rem; font-weight: bold; cursor: pointer; background: transparent; color: #666; }
        .lang-btn.active { background: #0056b3; color: white; }
        .preview-label { font-size: 0.8rem; color: #666; font-weight: bold; border-bottom: 1px dashed #999; display: block; margin-bottom: 10px; margin-top: 20px; }

        /* ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ */
        .news-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .news-date { font-family: 'Roboto', sans-serif; color: #666; width: 100px; font-size: 0.9rem; }
        .news-tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; margin-right: 15px; color: white; width: 110px; text-align: center; }
        .tag-release { background: #0056b3; }
        .tag-update { background: #e67e22; }
        .tag-start { background: #8e44ad; }
        .tag-steam { background: #2c3e50; }
        .tag-game { background: #27ae60; }
        .news-link { text-decoration: none; color: #333; font-weight: 500; font-family: 'Noto Serif JP', serif; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ¨ªä¸¦ã³ç”¨ã‚³ãƒ³ãƒ†ãƒŠï¼‰ */
        .cards-container { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        
        .highlight-card { flex: 0 0 250px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .highlight-img-area { width: 100%; height: 150px; background: #eee; position: relative; }
        .highlight-img { width: 100%; height: 100%; object-fit: cover; }
        .highlight-category-badge { position: absolute; bottom: 0; left: 0; color: white; font-size: 0.7rem; padding: 3px 10px; border-top-right-radius: 8px; font-weight: bold; }
        .highlight-content { padding: 10px; text-align: left; }
        .highlight-meta { font-size: 0.7rem; color: #666; margin-bottom: 5px; }
        .highlight-title { font-family: 'Noto Serif JP', serif; font-size: 0.95rem; font-weight: 900; color: #333; line-height: 1.4; height: 4.2em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }

        /* è©³ç´°ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (iframe) */
        .page-preview { margin-top: 10px; background: white; border-radius: 8px; overflow: hidden; height: 500px; border: 1px solid #ccc; position: relative; }
        .page-preview iframe { width: 100%; height: 100%; border: none; }
        .page-placeholder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #f9f9f9; color: #999; flex-direction: column; }

        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%; }
        .btn-calc { background: #007acc; color: white; }
        .btn-save { background: #27ae60; color: white; }
        
        /* è¨ˆç®—æ©Ÿ */
        .calc-container { max-width: 800px; margin: 0 auto; background: #2d2d30; padding: 30px; border-radius: 10px; }
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .calc-result-box { background: #1e1e1e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; border: 1px solid #444; }
        .calc-number { font-size: 3rem; color: #e67e22; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-container-split">
            <div class="login-left">
                <h2>ğŸš€ KEI Lab Admin</h2>
                <input type="password" id="tokenInput" placeholder="GitHub Token (ghp_...)">
                <button onclick="checkIdentity()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="authStatus"></div>
            </div>
            <div class="login-right">
                <h3>ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ‰‹é †</h3>
                <p>GitHub Settings > Developer settings > Personal access tokens (classic) ã‹ã‚‰ <strong>[repo]</strong> æ¨©é™ã‚’ä»˜ä¸ã—ã¦ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        </div>
    </div>

    <div id="mainWrapper">
        <div class="dashboard">
            <div class="sidebar">
                <h1>ğŸš€ KEI Lab Admin</h1>
                <div class="menu-btn active" onclick="switchPanel('calc')">ğŸ’° åç›Šãƒ»ç§’æ•°è¨ˆç®—</div>
                <div class="menu-btn" onclick="switchPanel('cms')">ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†</div>
                <!-- 1. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã¿ï¼‰ -->
                <div class="menu-btn" onclick="switchPanel('projects')">ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</div>
                
                <!-- ç©ºæ¬„ï¼ˆã‚¹ãƒšãƒ¼ã‚µãƒ¼ï¼‰ -->
                <div class="spacer"></div>
                
                <div class="menu-btn" onclick="switchPanel('users')">ğŸ‘¥ æ¨©é™ç®¡ç†</div>
                <div class="menu-btn" onclick="logout()" style="margin-top:10px; background:#c0392b; color:white;">ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
            </div>

            <div class="main-content">
                <!-- è¨ˆç®—æ©Ÿãƒ‘ãƒãƒ« -->
                <div id="panel-calc" class="panel active">
                    <div class="calc-container">
                        <h2>ğŸ’° ç„¡æ–™é€šè©±ç§’æ•° ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                        <div class="calc-grid">
                            <div><label>å‹•ç”»åºƒå‘Šå˜ä¾¡</label><input type="number" id="adPrice" value="1.5" step="0.1"> å††</div>
                            <div><label>é€šè©±åŸä¾¡ (1åˆ†)</label><input type="number" id="callCost" value="3.0" step="0.1"> å††</div>
                        </div>
                        <label>åˆ©ç›Šç‡ (%) <span id="marginDisplay" style="color:#007acc;">20%</span></label>
                        <input type="range" id="margin" min="0" max="50" value="20" oninput="document.getElementById('marginDisplay').innerText = this.value + '%'">
                        <button class="btn-calc" onclick="calcSeconds()">è¨ˆç®—ã™ã‚‹</button>
                        <div class="calc-result-box">
                            <div class="calc-number" id="calcOutput">--- ç§’</div>
                        </div>
                    </div>
                </div>

                <!-- CMSãƒ‘ãƒãƒ« -->
                <div id="panel-cms" class="panel">
                    <div class="cms-layout">
                        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
                        <div class="editor-area">
                            <h2>ğŸ“ è¨˜äº‹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
                            
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="text" id="inDate" class="input-white" style="width:100% !important;">
                            </div>
                            <div class="form-group">
                                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                                <select id="inCategory" class="input-white" style="width:100% !important;" onchange="updatePreview()">
                                    <option value="update">æ›´æ–°æƒ…å ±</option>
                                    <option value="release">ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="start">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹</option>
                                    <option value="steam">Steamãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="game">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (index_phot)</label>
                                <input type="hidden" id="inImage" onchange="updatePreview()">
                                <div class="custom-select-wrapper">
                                    <div class="custom-select">
                                        <div class="custom-select__trigger" onclick="toggleImageSelect()">
                                            <span id="selectedImageText">ç”»åƒã‚’é¸æŠ...</span><span>â–¼</span>
                                        </div>
                                        <div class="custom-options" id="imageOptions"></div>
                                    </div>
                                </div>
                            </div>

                            <hr style="border:0; border-top:1px dashed #555; margin: 20px 0;">

                            <div class="editor-lang-tabs">
                                <button class="edit-tab active" onclick="switchEditorLang('ja')">ğŸ‡¯ğŸ‡µ JP</button>
                                <button class="edit-tab" onclick="switchEditorLang('en')">ğŸ‡ºğŸ‡¸ EN</button>
                                <button class="edit-tab" onclick="switchEditorLang('de')">ğŸ‡©ğŸ‡ª DE</button>
                                <button class="edit-tab" onclick="switchEditorLang('fr')">ğŸ‡«ğŸ‡· FR</button>
                                <button class="edit-tab" onclick="switchEditorLang('es')">ğŸ‡ªğŸ‡¸ ES</button>
                            </div>

                            <!-- JP (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) -->
                            <div id="group-ja" class="lang-input-group active">
                                <div class="form-group">
                                    <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (JP)ã€€ã€€ã€€news_data.js</label>
                                    <div class="input-group">
                                        <input type="text" id="inProject" class="input-white" placeholder="å…¥åŠ›ã¾ãŸã¯é¸æŠ" oninput="autoFillProject()" autocomplete="off">
                                        <select id="projectSelectHelper" class="input-white" onchange="syncProjectSelect()">
                                            <option value="">â–¼ å±¥æ­´...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group"><label>ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ (JP)</label><input type="text" id="inTitle" class="input-white" oninput="updatePreview()"></div>
                                <!-- 3. è©³ç´°æœ¬æ–‡ â†’ ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ ã«å¤‰æ›´ -->
                                <div class="form-group"><label>ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ (JP)</label><textarea id="inBody" class="input-white" style="height:150px;" oninput="updatePreview()"></textarea></div>
                            </div>

                            <!-- EN -->
                            <div id="group-en" class="lang-input-group">
                                <div class="form-group"><label>Project Name (EN)</label><input type="text" id="inProjectEn" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Title (EN)</label><input type="text" id="inTitleEn" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>App Introduction Body (EN)</label><textarea id="inBodyEn" class="input-white" style="height:150px;" oninput="updatePreview()"></textarea></div>
                            </div>
                            <!-- DE -->
                            <div id="group-de" class="lang-input-group">
                                <div class="form-group"><label>Projektname (DE)</label><input type="text" id="inProjectDe" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Titel (DE)</label><input type="text" id="inTitleDe" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>App-EinfÃ¼hrungstext (DE)</label><textarea id="inBodyDe" class="input-white" style="height:150px;" oninput="updatePreview()"></textarea></div>
                            </div>
                            <!-- FR -->
                            <div id="group-fr" class="lang-input-group">
                                <div class="form-group"><label>Nom du projet (FR)</label><input type="text" id="inProjectFr" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Titre (FR)</label><input type="text" id="inTitleFr" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Texte d'introduction (FR)</label><textarea id="inBodyFr" class="input-white" style="height:150px;" oninput="updatePreview()"></textarea></div>
                            </div>
                            <!-- ES -->
                            <div id="group-es" class="lang-input-group">
                                <div class="form-group"><label>Nombre del proyecto (ES)</label><input type="text" id="inProjectEs" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>TÃ­tulo (ES)</label><input type="text" id="inTitleEs" class="input-white" oninput="updatePreview()"></div>
                                <div class="form-group"><label>Texto de introducciÃ³n (ES)</label><textarea id="inBodyEs" class="input-white" style="height:150px;" oninput="updatePreview()"></textarea></div>
                            </div>

                            <!-- 5. ä¿å­˜å®Ÿè¡Œï¼ -->
                            <button class="btn-save" onclick="saveExecution()">ä¿å­˜å®Ÿè¡Œï¼ï¼ˆå…¨è‡ªå‹•ç”Ÿæˆï¼‰</button>
                        </div>

                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                        <div class="preview-area">
                            <div class="preview-header">
                                <h2 style="border:none; margin:0; font-size:1.1rem; color:#333;">ğŸ‘ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                                <div class="lang-toggle">
                                    <button class="lang-btn active" id="btnPrevJa" onclick="setPreviewLang('ja')">JP</button>
                                    <button class="lang-btn" id="btnPrevEn" onclick="setPreviewLang('en')">EN</button>
                                    <button class="lang-btn" id="btnPrevDe" onclick="setPreviewLang('de')">DE</button>
                                    <button class="lang-btn" id="btnPrevFr" onclick="setPreviewLang('fr')">FR</button>
                                    <button class="lang-btn" id="btnPrevEs" onclick="setPreviewLang('es')">ES</button>
                                </div>
                            </div>

                            <span class="preview-label">â–¼ ãŠçŸ¥ã‚‰ã› (News List)</span>
                            <div class="news-item">
                                <span class="news-date" id="prevDate">2026.03.15</span>
                                <span class="news-tag tag-update" id="prevTag">æ›´æ–°æƒ…å ±</span>
                                <div style="flex:1;">
                                    <span style="font-weight:bold; margin-right:10px; color:#333;" id="prevProjectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                    <span class="news-link" id="prevTitle">ã‚¿ã‚¤ãƒˆãƒ«</span>
                                </div>
                            </div>

                            <!-- 2. æœ€æ–°ã®æ´»å‹• & ã‚¢ãƒ—ãƒªç´¹ä»‹ï¼ˆä¸¦åˆ—è¡¨ç¤ºï¼‰ -->
                            <div style="display: flex; gap: 20px; align-items: flex-start; margin-top: 20px;">
                                <div>
                                    <span class="preview-label" style="margin-top:0;">â–¼ æœ€æ–°ã®æ´»å‹• (Highlights)</span>
                                    <div class="highlight-card">
                                        <div class="highlight-img-area">
                                            <img src="" id="prevImg" class="highlight-img">
                                            <span class="highlight-category-badge tag-update" id="prevCardCatBadge">æ›´æ–°æƒ…å ±</span>
                                        </div>
                                        <div class="highlight-content">
                                            <div class="highlight-meta"><span id="prevCardDate"></span> | <span id="prevCardProj"></span></div>
                                            <div class="highlight-title" id="prevCardTitle">ã‚¿ã‚¤ãƒˆãƒ«</div>
                                        </div>
                                    </div>
                                    <p style="font-size:0.7rem; color:#999;" id="highlightMsg">â€»å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªã®ã¿è¡¨ç¤º</p>
                                </div>

                                <div>
                                    <span class="preview-label" style="margin-top:0;">â–¼ ã‚¢ãƒ—ãƒªç´¹ä»‹ (App Intro)</span>
                                    <div class="highlight-card">
                                        <div class="highlight-img-area">
                                            <img src="" id="prevIntroImg" class="highlight-img">
                                            <span class="highlight-category-badge" style="background:#444;">App</span>
                                        </div>
                                        <div class="highlight-content">
                                            <div class="highlight-meta"><span id="prevIntroProj">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span></div>
                                            <div class="highlight-title" id="prevIntroBody">ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. è©³ç´°ãƒšãƒ¼ã‚¸ (Homepage) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                            <span class="preview-label">â–¼ è©³ç´°ãƒšãƒ¼ã‚¸ (Project Page)</span>
                            <div class="page-preview">
                                <div class="page-placeholder" id="pagePlaceholder">
                                    <p>ã“ã“ã«HPãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                    <p style="font-size:0.8rem;">[Project]/index.html</p>
                                </div>
                                <iframe id="prevPageIframe" src=""></iframe>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 1. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ãƒ‘ãƒãƒ« (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼) -->
                <div id="panel-projects" class="panel">
                    <div class="calc-container"><h2>ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</h2><p>ã“ã“ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆå°†æ¥å®Ÿè£…ï¼‰</p></div>
                </div>

                <!-- æ¨©é™ç®¡ç†ãƒ‘ãƒãƒ« -->
                <div id="panel-users" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ‘¥ æ¨©é™ç®¡ç†</h2>
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <input type="text" id="newUserId" placeholder="GitHub ID" style="flex:1;">
                            <button class="btn-save" style="width:auto;" onclick="addUser()">è¿½åŠ </button>
                        </div>
                        <ul id="userList" style="background:#1e1e1e; padding:20px; list-style:none;"></ul>
                        <button class="btn-copy" onclick="saveUsersToGitHub()">ğŸ’¾ ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_CONFIG = { owner: "KeiAppLab", repo: "KeiAppLab" };
        let previewLang = 'ja';

        // --- èªè¨¼ ---
        async function checkIdentity() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) return;
            try {
                const res = await fetch("https://api.github.com/user", { headers: { Authorization: `token ${token}` } });
                if (!res.ok) throw new Error("ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³");
                const u = await res.json();
                if (typeof allowedUsersData !== 'undefined' && allowedUsersData.includes(u.login)) {
                    localStorage.setItem('gh_token', token);
                    showDashboard();
                } else { alert("è¨±å¯ã•ã‚Œã¦ã„ãªã„IDã§ã™"); }
            } catch (e) { alert(e.message); }
        }
        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainWrapper').style.display = 'block';
            updatePreview(); initProjectList(); initImageSelector();
        }
        function logout() { localStorage.removeItem('gh_token'); location.reload(); }
        window.addEventListener('load', () => { if (localStorage.getItem('gh_token')) checkIdentity(); renderUserList(); });

        // --- ãƒ‘ãƒãƒ«åˆ‡æ›¿ ---
        function switchPanel(id) {
            document.querySelectorAll('.panel').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- è¨ˆç®—æ©Ÿ ---
        function calcSeconds() {
            const p=parseFloat(document.getElementById('adPrice').value), c=parseFloat(document.getElementById('callCost').value), m=parseFloat(document.getElementById('margin').value);
            const sec = Math.floor((p - (p*(m/100))) / (c/60));
            document.getElementById('calcOutput').innerText = sec + " ç§’";
        }

        // --- ã‚¨ãƒ‡ã‚£ã‚¿ ---
        document.getElementById('inDate').value = new Date().toISOString().slice(0,10).replace(/-/g,'.');
        
        function switchEditorLang(lang) {
            document.querySelectorAll('.lang-input-group').forEach(e => e.classList.remove('active'));
            document.getElementById('group-'+lang).classList.add('active');
            document.querySelectorAll('.edit-tab').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function initProjectList() {
            if (typeof newsData === 'undefined') return;
            const s = document.getElementById('projectSelectHelper');
            s.innerHTML = '<option value="">â–¼ å±¥æ­´...</option>';
            [...new Set(newsData.map(i => i.project).filter(p=>p))].forEach(p => {
                let o = document.createElement('option'); o.value=p; o.textContent=p; s.appendChild(o);
            });
        }
        function syncProjectSelect() {
            const v = document.getElementById('projectSelectHelper').value;
            if(v) { document.getElementById('inProject').value = v; autoFillProject(); document.getElementById('projectSelectHelper').selectedIndex=0; }
        }
        function autoFillProject() {
            const p = document.getElementById('inProject').value.trim();
            if(!p) { updatePreview(); return; }
            const t = newsData.slice().reverse().find(i => i.project === p);
            if(t) {
                const f = {ja:'', en:'En', de:'De', fr:'Fr', es:'Es'};
                for(let k in f) {
                    document.getElementById('inProject'+f[k]).value = t['project'+(k=='ja'?'':'_'+k)]||'';
                    document.getElementById('inTitle'+f[k]).value = t['title'+(k=='ja'?'':'_'+k)]||'';
                    document.getElementById('inBody'+f[k]).value = t['body'+(k=='ja'?'':'_'+k)]||''; // ç´¹ä»‹æ–‡
                }
                setImageValue(t.image||'');
            }
            updatePreview();
        }
        
        function initImageSelector() {
            const c = document.getElementById('imageOptions'); c.innerHTML='';
            const l = (typeof photoList!=='undefined')?photoList:["no_image.png"];
            l.forEach(n => {
                let d=document.createElement('div'); d.className='custom-option';
                d.onclick=()=>{ selectImage(n); };
                d.innerHTML=`<img src="index_phot/${n}" class="option-img" onerror="this.src='https://via.placeholder.com/40'">${n}`;
                c.appendChild(d);
            });
        }
        function toggleImageSelect() { document.querySelector('.custom-select').classList.toggle('open'); }
        function selectImage(n) { document.getElementById('inImage').value="index_phot/"+n; document.getElementById('selectedImageText').textContent=n; document.querySelector('.custom-select').classList.remove('open'); updatePreview(); }
        function setImageValue(p) { document.getElementById('inImage').value=p; document.getElementById('selectedImageText').textContent=p.split('/').pop()||"é¸æŠ..."; }
        window.onclick = e => { if(!e.target.closest('.custom-select-wrapper')) document.querySelector('.custom-select').classList.remove('open'); };

        function setPreviewLang(l) { 
            previewLang=l; 
            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('btnPrev'+l.charAt(0).toUpperCase()+l.slice(1)).classList.add('active');
            updatePreview();
        }

        function updatePreview() {
            const cat = document.getElementById('inCategory').value;
            const img = document.getElementById('inImage').value;
            const date = document.getElementById('inDate').value;
            const s = previewLang==='ja'?'':previewLang.charAt(0).toUpperCase()+previewLang.slice(1);
            
            const proj = document.getElementById('inProject'+s).value || "Project";
            const title = document.getElementById('inTitle'+s).value || "Title";
            const body = document.getElementById('inBody'+s).value || "App Intro..."; // ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡

            // News List
            document.getElementById('prevDate').textContent = date;
            document.getElementById('prevTitle').textContent = title;
            document.getElementById('prevProjectName').textContent = proj;
            const tag = document.getElementById('prevTag');
            const cats = {
                'ja': {'release':'ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹','update':'æ›´æ–°æƒ…å ±','start':'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹','steam':'Steamãƒªãƒªãƒ¼ã‚¹','game':'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ '},
                'en': {'release':'Release','update':'Update','start':'Project Start','steam':'Steam','game':'Mini Game'},
                'de': {'release':'VerÃ¶ffentlichung','update':'Aktualisierung','start':'Projektstart','steam':'Steam','game':'Minispiel'},
                'fr': {'release':'Sortie','update':'Mise Ã  jour','start':'DÃ©but du projet','steam':'Steam','game':'Mini-jeu'},
                'es': {'release':'Lanzamiento','update':'ActualizaciÃ³n','start':'Inicio del proyecto','steam':'Steam','game':'Mini juego'}
            };
            tag.textContent = cats[previewLang][cat] || cat;
            tag.className = 'news-tag tag-'+cat;

            // Highlight Card
            document.getElementById('prevImg').src = img;
            document.getElementById('prevImg').style.display = img ? 'block' : 'none';
            document.getElementById('prevCardTitle').textContent = title;
            document.getElementById('prevCardProj').textContent = proj;
            document.getElementById('prevCardDate').textContent = date;
            const ct = document.getElementById('prevCardCatBadge');
            ct.textContent = tag.textContent; ct.className = 'highlight-category-badge tag-'+cat;
            
            const isHigh = ['release','start','steam'].includes(cat) && img;
            document.getElementById('highlightMsg').style.visibility = isHigh ? 'hidden' : 'visible';

            // App Intro Card
            document.getElementById('prevIntroImg').src = img;
            document.getElementById('prevIntroProj').textContent = proj;
            document.getElementById('prevIntroBody').textContent = body;

            // Project Page (Homepage)
            const iframe = document.getElementById('prevPageIframe');
            const holder = document.getElementById('pagePlaceholder');
            const projDir = document.getElementById('inProject').value.trim(); // ãƒ•ã‚©ãƒ«ãƒ€åã¯JPåŸºæº–ã¨ã™ã‚‹
            
            if(projDir) {
                iframe.style.display = 'block';
                holder.style.display = 'none';
                // å®Ÿéš›ã«ã¯å­˜åœ¨ã—ãªã„ã¨404ã«ãªã‚‹ãŒã€URLæ§‹é€ ã®ç¢ºèªç”¨
                iframe.src = projDir + "/index.html";
            } else {
                iframe.style.display = 'none';
                holder.style.display = 'flex';
            }
        }

        // --- 5. ä¿å­˜å®Ÿè¡Œï¼ï¼ˆå…¨è‡ªå‹•ç”Ÿæˆï¼‰ ---
        async function saveExecution() {
            const token = localStorage.getItem('gh_token');
            if(!token) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; }
            if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ãƒ»ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

            // 1. å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
            const post = {
                id: Date.now(),
                date: document.getElementById('inDate').value,
                category: document.getElementById('inCategory').value,
                image: document.getElementById('inImage').value,
                project: document.getElementById('inProject').value,
                title: document.getElementById('inTitle').value,
                body: document.getElementById('inBody').value, // ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡
                // å¤šè¨€èª
                project_en: document.getElementById('inProjectEn').value,
                title_en: document.getElementById('inTitleEn').value,
                body_en: document.getElementById('inBodyEn').value,
                project_de: document.getElementById('inProjectDe').value,
                title_de: document.getElementById('inTitleDe').value,
                body_de: document.getElementById('inBodyDe').value,
                project_fr: document.getElementById('inProjectFr').value,
                title_fr: document.getElementById('inTitleFr').value,
                body_fr: document.getElementById('inBodyFr').value,
                project_es: document.getElementById('inProjectEs').value,
                title_es: document.getElementById('inTitleEs').value,
                body_es: document.getElementById('inBodyEs').value,
            };

            if(!post.project) { alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå(JP)ã¯å¿…é ˆã§ã™"); return; }

            // 2. news_data.js (Master) ã®æ›´æ–°æº–å‚™
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®newsDataã«è¿½è¨˜
            if(typeof newsData === 'undefined') window.newsData = [];
            newsData.unshift(post); // å…ˆé ­ã«è¿½åŠ 

            try {
                // ä¸¦åˆ—ã§ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
                await Promise.all([
                    saveMaster(token),
                    saveIndexNews(token),
                    saveAppsList(token, post),
                    saveAppsSummary(token),
                    saveProjectNews(token, post.project)
                ]);
                alert("ä¿å­˜å®Œäº†ï¼\nãƒ»Master\nãƒ»Index News\nãƒ»Apps List\nãƒ»Apps Summary\nãƒ»Project News\nã™ã¹ã¦æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
                location.reload(); // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰
            } catch(e) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
            }
        }

        // A. Master Save (news_data.js)
        async function saveMaster(token) {
            const content = `// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ admin.html ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸ\nconst newsData = ${JSON.stringify(newsData, null, 4)};`;
            await uploadFile(token, "news_data.js", content, "Update Master Data");
        }

        // B. Index News (ãƒˆãƒƒãƒ—ç”¨: å„10ä»¶)
        async function saveIndexNews(token) {
            // ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹æ  (release, start, steam)
            const rel = newsData.filter(d => ['release','start','steam'].includes(d.category)).slice(0, 10);
            // æ›´æ–°æ  (update, game)
            const upd = newsData.filter(d => ['update','game'].includes(d.category)).slice(0, 10);
            const merged = [...rel, ...upd];
            const content = `const indexNewsData = ${JSON.stringify(merged, null, 4)};`;
            await uploadFile(token, "index_news.js", content, "Update Index News");
        }

        // C. Apps List (çŸ¥ã‚‹ãƒ»æ¥½ã—ã‚€ç”¨: ã‚¢ãƒ—ãƒªç´¹ä»‹)
        async function saveAppsList(token, currentPost) {
            // appsListData ã¯HTMLãƒ­ãƒ¼ãƒ‰æ™‚ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹æƒ³å®š
            if(typeof appsListData === 'undefined') window.appsListData = [];
            
            // åŒã˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
            const idx = appsListData.findIndex(p => p.project === currentPost.project);
            const appEntry = {
                project: currentPost.project,
                image: currentPost.image,
                intro_ja: currentPost.body, // ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡
                intro_en: currentPost.body_en,
                intro_de: currentPost.body_de,
                intro_fr: currentPost.body_fr,
                intro_es: currentPost.body_es,
                url: `${currentPost.project}/index.html` // HPã®å ´æ‰€
            };

            if(idx >= 0) {
                appsListData[idx] = appEntry;
            } else {
                appsListData.push(appEntry);
            }

            const content = `const appsListData = ${JSON.stringify(appsListData, null, 4)};`;
            await uploadFile(token, "apps_list.js", content, "Update Apps List");
        }

        // D. Apps Summary (adminé–²è¦§ç”¨: å„3ä»¶ æ—¥è‹±)
        async function saveAppsSummary(token) {
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groups = {};
            newsData.forEach(d => {
                if(!groups[d.project]) groups[d.project] = [];
                groups[d.project].push(d);
            });

            const summary = [];
            for(let proj in groups) {
                // æœ€æ–°3ä»¶å–å¾—
                const top3 = groups[proj].slice(0, 3).map(d => ({
                    date: d.date,
                    cat: d.category,
                    title_ja: d.title,
                    title_en: d.title_en
                }));
                summary.push({ project: proj, news: top3 });
            }
            
            const content = `const appsSummaryData = ${JSON.stringify(summary, null, 4)};`;
            await uploadFile(token, "apps_summary.js", content, "Update Apps Summary");
        }

        // E. Project News (å€‹åˆ¥HPç”¨: å…¨ä»¶)
        async function saveProjectNews(token, projName) {
            const pNews = newsData.filter(d => d.project === projName);
            // ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹: [Projectå]/news.js
            const path = `${projName}/news.js`;
            const content = `const projectNewsData = ${JSON.stringify(pNews, null, 4)};`;
            await uploadFile(token, path, content, `Update ${projName} News`);
        }

        // æ±ç”¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢æ•°
        async function uploadFile(token, path, content, msg) {
            // SHAå–å¾—
            let sha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                    headers: { Authorization: `token ${token}` }
                });
                if(res.ok) {
                    const json = await res.json();
                    sha = json.sha;
                }
            } catch(e) {} // æ–°è¦ä½œæˆæ™‚ã¯ç„¡è¦–

            // PUT
            const encoded = btoa(unescape(encodeURIComponent(content)));
            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg, content: encoded, sha: sha })
            });
            if(!res.ok) throw new Error(`Failed to save ${path}`);
        }

        // --- æ¨©é™ç®¡ç† ---
        function renderUserList() {
            const l = document.getElementById('userList'); if(!l)return; l.innerHTML='';
            if(typeof allowedUsersData!=='undefined') allowedUsersData.forEach((u,i)=>{
                l.innerHTML+=`<li style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #333; color:white;">${u}<button onclick="removeUser(${i})" style="width:auto; padding:2px 8px; margin:0; background:#c0392b;">å‰Šé™¤</button></li>`;
            });
        }
        function addUser(){ const i=document.getElementById('newUserId'); const v=i.value.trim(); if(v && !allowedUsersData.includes(v)){ allowedUsersData.push(v); i.value=''; renderUserList(); } }
        function removeUser(i){ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { allowedUsersData.splice(i,1); renderUserList(); } }
        async function saveUsersToGitHub() {
            const token=localStorage.getItem('gh_token'); if(!token)return;
            const c=`const allowedUsersData = ${JSON.stringify(allowedUsersData,null,4)};`;
            await uploadFile(token, 'allowed_users.js', c, 'Update Users');
            alert('æ¨©é™æ›´æ–°å®Œäº†');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEI Lab ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</title>

    <!-- ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ (ãƒ•ã‚¡ã‚¤ãƒ«åä¿®æ­£: news_data.js) -->
    <script src="news_data.js"></script>
    <script src="allowed_users.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Roboto:wght@400;500;900&display=swap');

        /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: #1e1e1e; color: #ddd; height: 100vh; overflow: hidden; }
        #mainWrapper { display: none; height: 100%; }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-container-split {
            display: flex; width: 800px; height: 500px;
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-left {
            width: 40%; padding: 40px; display: flex; flex-direction: column;
            justify-content: center; background: #f9f9f9; border-right: 1px solid #eee;
        }
        .login-left input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-left button { width: 100%; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-left button:hover { background: #003d82; }
        .login-right { width: 60%; padding: 40px; overflow-y: auto; color: #333; line-height: 1.6; }
        .login-right h3 { border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-top: 0; }
        .login-right ol { padding-left: 20px; }
        .login-right li { margin-bottom: 10px; font-size: 0.9rem; }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        .dashboard { display: grid; grid-template-columns: 250px 1fr; height: 100%; }
        .sidebar { background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; }
        .sidebar h1 { font-size: 1.2rem; color: #fff; margin: 20px 10px; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
        .menu-btn { 
            padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 5px; color: #aaa; font-weight: bold; transition: 0.2s; 
            display: flex; align-items: center; gap: 10px;
        }
        .menu-btn:hover { background: #3c3c3c; color: #fff; }
        .menu-btn.active { background: #007acc; color: white; }

        .main-content { position: relative; overflow: hidden; height: 100%; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .panel.active { display: block; }

        /* --- è¨ˆç®—æ©Ÿã‚¹ã‚¿ã‚¤ãƒ« --- */
        .calc-container { max-width: 800px; margin: 0 auto; background: #2d2d30; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .calc-result-box { background: #1e1e1e; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; border: 1px solid #444; }
        .calc-number { font-size: 3rem; color: #e67e22; font-weight: bold; }
        .calc-sub { color: #27ae60; font-size: 1rem; margin-top: 10px; }

        /* --- CMSã‚¹ã‚¿ã‚¤ãƒ« --- */
        .cms-layout { display: flex; height: 100%; gap: 20px; }
        .editor-area { width: 45%; overflow-y: auto; padding-right: 10px; height: 100%; }
        .preview-area { width: 55%; background: #f0f0f0; color: #333; border-radius: 8px; overflow-y: auto; padding: 20px; height: 100%; }

        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 20px; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #aaa; }
        input, select, textarea { width: 100%; padding: 10px; background: #3c3c3c; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; font-family: sans-serif; }
        input:focus, select:focus, textarea:focus { border-color: #007acc; outline: none; z-index: 10; position: relative; }
        
        /* ç™½ã„å…¥åŠ›æ¬„ (æ—¥æœ¬èª) */
        .input-white {
            background-color: #ffffff !important;
            color: #333 !important;
            border: 1px solid #ccc !important;
            font-weight: bold;
        }
        /* ã‚°ãƒ¬ãƒ¼ã®å…¥åŠ›æ¬„ (è‹±èª) */
        .input-gray {
            background-color: #e9ecef !important;
            color: #333 !important;
            border: 1px solid #ccc !important;
        }
        /* åŠè§’å…¥åŠ›å¼·åˆ¶ (CSS) */
        .half-width {
            ime-mode: disabled; /* IE/Firefoxç”¨ */
            font-family: 'Roboto', monospace;
        }

        /* --- çµåˆã‚¹ã‚¿ã‚¤ãƒ« --- */
        /* ä¸Šæ®µ (æ—¥æœ¬èª) */
        .input-top {
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-bottom: 1px solid #eee !important;
            margin-bottom: 0 !important;
        }
        /* ä¸‹æ®µ (è‹±èª) ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .en-input-container {
            display: flex;
            align-items: center;
            background-color: #e9ecef;
            border: 1px solid #ccc;
            border-top: none;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            overflow: hidden;
        }
        .en-tag {
            color: #e67e22; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            font-weight: 900;
            padding: 0 10px;
            font-size: 0.9rem;
            user-select: none;
            background: #e9ecef;
        }
        .en-input-container input, 
        .en-input-container textarea {
            border: none !important;
            background-color: transparent !important;
            border-radius: 0 !important;
            flex: 1;
            padding: 10px 0 10px 0; /* å·¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¯ã‚¿ã‚°ã§ç¢ºä¿ */
        }
        .en-input-container textarea {
            height: 80px; /* è‹±èªæœ¬æ–‡ã¯å°‘ã—å°ã•ã‚ã§ã‚‚OK */
        }

        /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå…¥åŠ›ã‚¨ãƒªã‚¢ã®çµåˆã‚¹ã‚¿ã‚¤ãƒ« (ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å«ã‚€) */
        .input-group {
            display: flex;
            width: 100%;
        }
        .input-group input {
            flex: 7;
            border-top-right-radius: 0 !important;
            border-right: 0 !important;
            /* ä¸‹å´ã‚‚çµåˆã™ã‚‹ãŸã‚è§’ä¸¸ãªã— */
            border-bottom-right-radius: 0 !important; 
            border-bottom-left-radius: 0 !important;
            border-bottom: 1px solid #eee !important;
            margin-bottom: 0 !important;
        }
        .input-group select {
            flex: 3;
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important; /* ä¸‹å´çµåˆ */
            border-bottom: 1px solid #eee !important;
            background-color: #e6e6e6 !important;
            color: #0056b3 !important;
            cursor: pointer;
            margin-bottom: 0 !important;
        }

        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%; }
        .btn-calc { background: #007acc; color: white; font-size: 1.1rem; }
        .btn-save { background: #27ae60; color: white; }
        .btn-copy { background: #e67e22; color: white; margin-top: 20px; }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ */
        .preview-label { font-size: 0.8rem; color: #999; font-weight: bold; border-bottom: 1px dashed #ccc; display: block; margin-bottom: 10px; margin-top: 20px; }
        .news-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .news-date { font-family: 'Roboto', sans-serif; color: #666; width: 100px; font-size: 0.9rem; }
        .news-tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; margin-right: 15px; color: white; width: 110px; text-align: center; }
        .tag-release { background: #0056b3; }
        .tag-update { background: #e67e22; }
        .tag-start { background: #8e44ad; }
        .tag-steam { background: #2c3e50; }
        .tag-game { background: #27ae60; }
        
        .img-card { position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); aspect-ratio: 16/9; display: block; max-width: 100%; background: #ddd; }
        .img-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 15px; color: white; box-sizing: border-box; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin: 0; font-family: 'Noto Serif JP', serif; }
        .card-sub { font-size: 0.8rem; opacity: 0.9; margin-top: 5px; }

        .page-preview { font-family: 'Noto Serif JP', serif; line-height: 1.8; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; }
        .page-preview h1 { border-bottom: 3px solid #0056b3; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; font-size: 1.5rem; }
        .page-preview img { max-width: 100%; border-radius: 10px; margin: 20px 0; }

        #prevBody, .news-link { white-space: pre-wrap; }
    </style>
</head>
<body>

    <!-- 1. ãƒ­ã‚°ã‚¤ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loginOverlay">
        <div class="login-container-split">
            <div class="login-left">
                <h2>ğŸš€ KEI Lab Admin</h2>
                <p>ç®¡ç†è€…ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                <input type="password" id="tokenInput" placeholder="GitHub Token (ghp_...)">
                <button onclick="checkIdentity()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="authStatus"></div>
            </div>
            <div class="login-right">
                <h3>ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œæ‰‹é †</h3>
                <ol>
                    <li>GitHub Tokenè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•</li>
                    <li>[repo] ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ç”Ÿæˆ</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- 2. ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainWrapper">
        <div class="dashboard">
            <div class="sidebar">
                <h1>ğŸš€ KEI Lab Admin</h1>
                <div class="menu-btn active" onclick="switchPanel('calc')">ğŸ’° åç›Šãƒ»ç§’æ•°è¨ˆç®—</div>
                <div class="menu-btn" onclick="switchPanel('cms')">ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†</div>
                <div class="menu-btn" onclick="switchPanel('users')">ğŸ‘¥ æ¨©é™ç®¡ç†</div>
                <div class="menu-btn" onclick="logout()" style="margin-top:auto; background:#c0392b; color:white;">ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
            </div>

            <div class="main-content">

                <!-- è¨ˆç®—æ©Ÿãƒ‘ãƒãƒ« -->
                <div id="panel-calc" class="panel active">
                    <div class="calc-container">
                        <h2>ğŸ’° ç„¡æ–™é€šè©±ç§’æ•° ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                        <div class="calc-grid">
                            <div><label>å‹•ç”»åºƒå‘Šå˜ä¾¡</label><input type="number" id="adPrice" value="1.5" step="0.1"> å††</div>
                            <div><label>é€šè©±åŸä¾¡ (1åˆ†)</label><input type="number" id="callCost" value="3.0" step="0.1"> å††</div>
                        </div>
                        <label>ç¢ºä¿ã—ãŸã„åˆ©ç›Šç‡ (%) <span id="marginDisplay" style="color:#007acc; margin-left:10px;">20%</span></label>
                        <input type="range" id="margin" min="0" max="50" value="20" oninput="document.getElementById('marginDisplay').innerText = this.value + '%'">
                        <button class="btn-calc" onclick="calcSeconds()">è¨ˆç®—ã™ã‚‹</button>
                        <div class="calc-result-box">
                            <div style="color:#aaa; font-size:0.9rem;">ã‚¢ãƒ—ãƒªã«è¨­å®šã™ã¹ããƒãƒ£ãƒ¼ã‚¸ç§’æ•°</div>
                            <div id="calcOutput" class="calc-number">--- ç§’</div>
                            <div id="profitOutput" class="calc-sub">(åºƒå‘Š1å›ã‚ãŸã‚Šã®ç´”åˆ©ç›Š: --- å††)</div>
                        </div>
                    </div>
                </div>

                <!-- CMSãƒ‘ãƒãƒ« -->
                <div id="panel-cms" class="panel">
                    <div class="cms-layout">
                        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ -->
                        <div class="editor-area">
                            <h2>ğŸ“ è¨˜äº‹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
                            
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="text" id="inDate" class="input-white" style="width:100% !important;">
                            </div>

                            <div class="form-group">
                                <label>ã‚«ãƒ†ã‚´ãƒª</label>
                                <select id="inCategory" class="input-white" style="width:100% !important;" onchange="updatePreview()">
                                    <option value="update">æ›´æ–°æƒ…å ±</option>
                                    <option value="release">ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="start">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹</option>
                                    <option value="steam">Steamãƒªãƒªãƒ¼ã‚¹</option>
                                    <option value="game">ã‚µã‚¤ãƒˆå†…ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </option>
                                </select>
                            </div>

                            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆæ—¥è‹±é€£çµï¼‰ -->
                            <div class="form-group">
                                <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
                                <div class="input-group">
                                    <input type="text" id="inProject" class="input-white" placeholder="å…¥åŠ›ã¾ãŸã¯å³ã‹ã‚‰å±¥æ­´é¸æŠ" oninput="autoFillProject()" autocomplete="off">
                                    <select id="projectSelectHelper" class="input-white" onchange="syncProjectSelect()">
                                        <!-- JSã§ç”Ÿæˆ -->
                                    </select>
                                </div>
                                <div class="en-input-container">
                                    <span class="en-tag">En</span>
                                    <input type="text" id="inProjectEn" class="input-gray half-width" placeholder="Project Name" autocomplete="off">
                                </div>
                            </div>

                            <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥è‹±é€£çµï¼‰ -->
                            <div class="form-group">
                                <label>ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</label>
                                <input type="text" id="inTitle" class="input-white input-top" style="width:100% !important;" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (JP)" oninput="updatePreview()" autocomplete="off">
                                <div class="en-input-container">
                                    <span class="en-tag">En</span>
                                    <input type="text" id="inTitleEn" class="input-gray half-width" placeholder="Title (EN)" autocomplete="off">
                                </div>
                            </div>

                            <!-- èª¬æ˜æ–‡(ä¸€è¦§)ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ -->

                            <!-- ç”»åƒ -->
                            <div class="form-group">
                                <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å</label>
                                <input type="text" id="inImage" class="input-white half-width" style="width:100% !important;" placeholder="ä¾‹: app-image.png (åŠè§’ã®ã¿)" oninput="updatePreview()" autocomplete="off">
                            </div>

                            <!-- æœ¬æ–‡ï¼ˆæ—¥è‹±é€£çµï¼‰ -->
                            <div class="form-group">
                                <label>è©³ç´°æœ¬æ–‡ (HTMLå¯)</label>
                                <textarea id="inBody" class="input-white input-top" placeholder="è©³ç´°å†…å®¹ (JP)" oninput="updatePreview()"></textarea>
                                <div class="en-input-container">
                                    <span class="en-tag">En</span>
                                    <textarea id="inBodyEn" class="input-gray half-width" placeholder="Details (EN)"></textarea>
                                </div>
                            </div>

                            <button class="btn-save" onclick="addPost()">ãƒªã‚¹ãƒˆã«è¿½åŠ  (ä¸€æ™‚ä¿å­˜)</button>
                            <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">
                            <button class="btn-copy" onclick="saveToGitHub()">ğŸš€ news_data.js ã‚’æ›´æ–° (GitHub)</button>
                        </div>

                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ—¥æœ¬èªã®ã¿è¡¨ç¤º) -->
                        <div class="preview-area">
                            <h2 style="color:#333; border-bottom-color:#ccc;">ğŸ‘ï¸ æ—¥æœ¬èªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                            
                            <span class="preview-label">â–¼ ãŠçŸ¥ã‚‰ã› (News List)</span>
                            <div class="news-item">
                                <span class="news-date" id="prevDate">2026.03.15</span>
                                <span class="news-tag tag-update" id="prevTag">æ›´æ–°æƒ…å ±</span>
                                <div style="flex:1;">
                                    <span style="font-weight:bold; margin-right:10px; color:#333;" id="prevProjectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                    <span class="news-link" id="prevTitle">ã‚¿ã‚¤ãƒˆãƒ«</span>
                                </div>
                            </div>

                            <span class="preview-label">â–¼ æœ€æ–°ã®æ´»å‹• (Highlights Card)</span>
                            <div id="highlightPreviewBox">
                                <div class="img-card">
                                    <img src="" alt="No Image" id="prevImg">
                                    <div class="card-overlay">
                                        <h3 class="card-title" id="prevCardTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                                        <div class="card-sub">
                                            <span id="prevCardDate">2026.03.15</span> | <span id="prevCardSub">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p style="font-size:0.8rem; color:red;" id="highlightMsg"></p>

                            <span class="preview-label">â–¼ è©³ç´°ãƒšãƒ¼ã‚¸ (Project Page)</span>
                            <div class="page-preview">
                                <h1 id="prevPageTitle">ã‚¿ã‚¤ãƒˆãƒ«</h1>
                                <div style="color:#666; font-size:0.9rem; margin-bottom:20px;">
                                    <span id="prevPageDate">2026.03.15</span> | <span id="prevPageProject">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                </div>
                                <img src="" id="prevPageImg" style="display:none;">
                                <div id="prevBody">æœ¬æ–‡...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ« -->
                <div id="panel-users" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ‘¥ ç·¨é›†æ¨©é™è€…ã®ç®¡ç†</h2>
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <input type="text" id="newUserId" placeholder="GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼ID" style="flex:1;" class="half-width">
                            <button class="btn-save" style="width:auto;" onclick="addUser()">è¿½åŠ </button>
                        </div>
                        <ul id="userList" style="background:#1e1e1e; padding:20px; border-radius:8px; list-style:none;"></ul>
                        <button class="btn-copy" onclick="saveUsersToGitHub()">ğŸ’¾ æ¨©é™è¨­å®šã‚’GitHubã«ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ è¨­å®š â–¼â–¼â–¼
        const GITHUB_CONFIG = {
            owner: "KeiAppLab",
            repo: "KeiAppLab",
            path: "news_data.js", // ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´
        };

        // --- CMSãƒ­ã‚¸ãƒƒã‚¯ ---
        let allPosts = []; // ç·¨é›†ä¸­ã®å…¨ãƒ‡ãƒ¼ã‚¿
        const today = new Date();
        document.getElementById('inDate').value = today.getFullYear() + '.' + (today.getMonth()+1).toString().padStart(2, '0') + '.' + today.getDate().toString().padStart(2, '0');

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('gh_token');
            if (savedToken) checkIdentity(savedToken);
            renderUserList();

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯èª­ã¿è¾¼ã‚€
            if (typeof newsData !== 'undefined') {
                allPosts = [...newsData];
            }
            // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–
            initProjectList();
        });

        // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆç”Ÿæˆï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”¨ï¼‰
        function initProjectList() {
            // allPosts ã¾ãŸã¯ newsData ã‹ã‚‰ãƒªã‚¹ãƒˆä½œæˆ
            const sourceData = (allPosts.length > 0) ? allPosts : (typeof newsData !== 'undefined' ? newsData : []);
            
            const projectSet = new Set();
            sourceData.forEach(item => {
                if(item.project) projectSet.add(item.project);
            });

            const selectBox = document.getElementById('projectSelectHelper');
            selectBox.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢
            selectBox.selectedIndex = -1; // æœªé¸æŠçŠ¶æ…‹ã«ã™ã‚‹

            projectSet.forEach(projName => {
                const option = document.createElement('option');
                option.value = projName;
                option.textContent = projName;
                selectBox.appendChild(option);
            });
            // åˆæœŸçŠ¶æ…‹ã¯æœªé¸æŠ
            selectBox.selectedIndex = -1;
        }

        // 2. ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã®åŒæœŸ
        function syncProjectSelect() {
            const selectBox = document.getElementById('projectSelectHelper');
            const inputBox = document.getElementById('inProject');
            
            if (selectBox.value) {
                inputBox.value = selectBox.value;
                autoFillProject(); // è‹±èªåãªã©ã‚‚è‡ªå‹•è£œå®Œ
                // é¸æŠçŠ¶æ…‹ã¯ç¶­æŒã§ã‚‚è‰¯ã„ãŒã€é€£ç¶šå…¥åŠ›ã‚’è€ƒæ…®ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ãªã„ã§ãŠãã‹ã€
                // ãƒªã‚»ãƒƒãƒˆã—ãŸã„å ´åˆã¯ selectBox.selectedIndex = -1;
            }
        }

        // 3. è‡ªå‹•å…¥åŠ›æ©Ÿèƒ½ (æ—¥è‹±å¯¾å¿œ)
        function autoFillProject() {
            const inputProject = document.getElementById('inProject').value.trim();
            const elProjectEn = document.getElementById('inProjectEn');
            // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è‡ªå‹•å…¥åŠ›ã—ãªã„ï¼ˆæ–°è¦è¨˜äº‹ä½œæˆã®é‚ªé­”ã«ãªã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®ã¿è£œå®ŒãŒä¸€èˆ¬çš„ã ãŒã€
            // æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦ã‚¿ã‚¤ãƒˆãƒ«ç­‰ã‚‚è£œå®Œã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–ã€‚
            // ä»Šå›ã¯ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®ä¸€è²«æ€§ã€ã®ãŸã‚ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®è‹±èªã®ã¿è£œå®Œã™ã‚‹å½¢ã«ã—ã¾ã™ã€‚

            if (inputProject === "") return;

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åŒã˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®è¨˜äº‹ã‚’æ¢ã™
            if (allPosts.length > 0) {
                const targetPost = allPosts.slice().reverse().find(post => post.project === inputProject);
                if (targetPost) {
                    if(targetPost.projectEn) elProjectEn.value = targetPost.projectEn;
                }
            }
        }

        function updatePreview() {
            const date = document.getElementById('inDate').value;
            const category = document.getElementById('inCategory').value;
            const project = document.getElementById('inProject').value;
            const title = document.getElementById('inTitle').value || "ã‚¿ã‚¤ãƒˆãƒ«";
            const image = document.getElementById('inImage').value;
            const body = document.getElementById('inBody').value;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ 
            document.getElementById('prevDate').textContent = date;
            document.getElementById('prevTitle').textContent = title;
            document.getElementById('prevProjectName').textContent = project;
            
            const tagEl = document.getElementById('prevTag');
            tagEl.className = 'news-tag tag-' + category;
            const catNames = {'release':'ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹','update':'æ›´æ–°æƒ…å ±','start':'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹','steam':'Steamãƒªãƒªãƒ¼ã‚¹','game':'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ '};
            tagEl.textContent = catNames[category];

            const highlightBox = document.getElementById('highlightPreviewBox');
            const highlightMsg = document.getElementById('highlightMsg');
            // ç”»åƒãŒã‚ã‚Šã€ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãªã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
            const isHighlight = (category === 'release' || category === 'start' || category === 'steam') && image !== "";

            if (isHighlight) {
                highlightBox.style.opacity = "1";
                highlightMsg.textContent = "";
                document.getElementById('prevImg').src = image;
                document.getElementById('prevImg').style.display = 'block';
                document.getElementById('prevCardTitle').textContent = title;
                document.getElementById('prevCardSub').textContent = project;
                document.getElementById('prevCardDate').textContent = date;
            } else {
                highlightBox.style.opacity = "0.4";
                highlightMsg.textContent = "â€»ã“ã®ã‚«ãƒ†ã‚´ãƒªã¾ãŸã¯ç”»åƒãªã—ã®ãŸã‚ã€ã€Œæœ€æ–°ã®æ´»å‹•ã€ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚";
                document.getElementById('prevImg').style.display = 'none';
            }

            document.getElementById('prevPageTitle').textContent = title;
            document.getElementById('prevPageDate').textContent = date;
            document.getElementById('prevPageProject').textContent = project;
            document.getElementById('prevBody').innerHTML = body;
            if(image) {
                document.getElementById('prevPageImg').src = image;
                document.getElementById('prevPageImg').style.display = 'block';
            } else {
                document.getElementById('prevPageImg').style.display = 'none';
            }
        }

        function addPost() {
            const newPost = {
                id: Date.now(),
                date: document.getElementById('inDate').value,
                category: document.getElementById('inCategory').value,
                // JP
                project: document.getElementById('inProject').value,
                title: document.getElementById('inTitle').value,
                body: document.getElementById('inBody').value,
                // EN (æ–°è¦è¿½åŠ )
                projectEn: document.getElementById('inProjectEn').value,
                titleEn: document.getElementById('inTitleEn').value,
                bodyEn: document.getElementById('inBodyEn').value,
                
                image: document.getElementById('inImage').value
            };

            if (!newPost.project) { alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            
            allPosts.unshift(newPost);
            alert(`ã€Œ${newPost.title}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nç¾åœ¨ ${allPosts.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚\nGitHubã¸ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç¢ºå®šã•ã‚Œã¾ã™ã€‚`);
        }

        // --- GitHubã¸ç›´æ¥ä¿å­˜ ---
        async function saveToGitHub() {
            const token = localStorage.getItem("gh_token");
            if (!token) { alert("èªè¨¼ãŒå¿…è¦ã§ã™"); return; }
            if(!confirm("GitHubä¸Šã® news_data.js ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

            const jsonString = JSON.stringify(allPosts, null, 4);
            // ãƒ•ã‚¡ã‚¤ãƒ«åã¯ news_data.js ã ãŒã€å¤‰æ•°åã¯ newsData ã®ã¾ã¾ã¨ã™ã‚‹
            const content = `// ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ admin.html ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸ\nconst newsData = ${jsonString};`;
            const encodedContent = btoa(unescape(encodeURIComponent(content)));

            try {
                // GETã—ã¦SHAã‚’å–å¾—
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: { Authorization: `token ${token}` }
                });
                
                let sha = null;
                if (getRes.ok) {
                    const fileData = await getRes.json();
                    sha = fileData.sha;
                }

                // PUTã§ä¸Šæ›¸ã
                const bodyData = {
                    message: "Update news_data.js from Admin Cockpit",
                    content: encodedContent
                };
                if (sha) bodyData.sha = sha;

                const putRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    method: "PUT",
                    headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify(bodyData)
                });

                if (putRes.ok) {
                    alert("GitHubã¸ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸï¼\nãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã€‚");
                    initProjectList(); // ä¿å­˜æˆåŠŸæ™‚ã«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                } else {
                    const err = await putRes.json();
                    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
                }
            } catch (err) { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }

        // --- èªè¨¼ãƒ»ãã®ä»– ---
        async function checkIdentity() {
            const tokenInput = document.getElementById('tokenInput');
            const token = (typeof arguments[0] === 'string') ? arguments[0] : tokenInput.value.trim();
            const status = document.getElementById('authStatus');
            
            if (!token) { status.innerText = "âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; status.style.color = "orange"; return; }
            status.innerText = "ç¢ºèªä¸­..."; status.style.color = "black";

            try {
                const res = await fetch("https://api.github.com/user", { headers: { Authorization: `token ${token}` } });
                if (!res.ok) throw new Error("ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™");
                const userData = await res.json();

                if (typeof allowedUsersData !== 'undefined' && allowedUsersData.includes(userData.login)) {
                    localStorage.setItem('gh_token', token);
                    showDashboard();
                } else {
                    status.innerText = "âŒ è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™: " + userData.login; status.style.color = "red";
                }
            } catch (err) { status.innerText = "âš ï¸ ã‚¨ãƒ©ãƒ¼: " + err.message; status.style.color = "red"; }
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainWrapper').style.display = 'block';
            updatePreview();
            initProjectList(); // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã«ã‚‚ãƒªã‚¹ãƒˆç”Ÿæˆ
        }

        function logout() { localStorage.removeItem('gh_token'); location.reload(); }
        
        function switchPanel(panelId) {
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('panel-' + panelId).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        function calcSeconds() {
            const adPrice = parseFloat(document.getElementById('adPrice').value);
            const callCost = parseFloat(document.getElementById('callCost').value);
            const margin = parseFloat(document.getElementById('margin').value);
            const costPerSec = callCost / 60;
            const profit = adPrice * (margin / 100);
            const seconds = Math.floor((adPrice - profit) / costPerSec);
            document.getElementById('calcOutput').innerText = seconds + " ç§’";
            document.getElementById('profitOutput').innerText = "(ç´”åˆ©ç›Š: " + profit.toFixed(2) + " å††)";
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†
        function renderUserList() {
            const list = document.getElementById('userList');
            if(!list) return;
            list.innerHTML = '';
            if (typeof allowedUsersData !== 'undefined') {
                allowedUsersData.forEach((user, index) => {
                    const li = document.createElement('li');
                    li.style = "display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #333; color:#fff;";
                    li.innerHTML = `<span>${user}</span><button style="background:#c0392b; width:auto; padding:5px 10px; font-size:0.8rem; margin:0;" onclick="removeUser(${index})">å‰Šé™¤</button>`;
                    list.appendChild(li);
                });
            }
        }
        function addUser() {
            const input = document.getElementById('newUserId');
            const id = input.value.trim();
            if(!id) return;
            if(allowedUsersData.includes(id)) { alert("æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"); return; }
            allowedUsersData.push(id);
            input.value = '';
            renderUserList();
        }
        function removeUser(index) {
            if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { allowedUsersData.splice(index, 1); renderUserList(); }
        }
        async function saveUsersToGitHub() {
            const token = localStorage.getItem("gh_token");
            if (!token) { alert("èªè¨¼ãŒå¿…è¦ã§ã™"); return; }
            if(!confirm("GitHubä¸Šã® allowed_users.js ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
            const jsonString = JSON.stringify(allowedUsersData, null, 4);
            const content = `// ç·¨é›†æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ\nconst allowedUsersData = ${jsonString};`;
            const encodedContent = btoa(unescape(encodeURIComponent(content)));
            try {
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/allowed_users.js`, { headers: { Authorization: `token ${token}` } });
                const fileData = await getRes.json();
                const putRes = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/allowed_users.js`, {
                    method: "PUT",
                    headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update allowed users list", content: encodedContent, sha: fileData.sha })
                });
                if (putRes.ok) alert("æ¨©é™è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸï¼"); else alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            } catch (err) { alert("ã‚¨ãƒ©ãƒ¼: " + err.message); }
        }
    </script>
</body>
</html>

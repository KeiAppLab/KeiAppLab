<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEI Lab ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</title>

    <!-- ç®¡ç†è€…ç”¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ -->
    <script src="admin_master.js"></script>
    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç”¨ãƒ‡ãƒ¼ã‚¿ -->
    <script src="index_news.js"></script>
    <!-- ã‚«ã‚¿ãƒ­ã‚°ãƒšãƒ¼ã‚¸ç”¨ãƒ‡ãƒ¼ã‚¿ -->
    <script src="apps_catalog.js"></script>
    
    <script src="allowed_users.js"></script>
    <script src="index_phot.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Roboto:wght@400;500;900&display=swap');

        /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Arial, sans-serif; background: #1e1e1e; color: #ddd; height: 100vh; overflow: hidden; }
        #mainWrapper { display: none; height: 100%; }

        /* --- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-container-split { display: flex; width: 850px; height: 550px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-left { width: 40%; padding: 40px; display: flex; flex-direction: column; justify-content: center; background: #f9f9f9; border-right: 1px solid #eee; }
        .login-left input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; }
        .login-left button { width: 100%; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-left button:hover { background: #003d82; }
        .login-right { width: 60%; padding: 40px; overflow-y: auto; color: #333; line-height: 1.6; }
        .login-right h3 { border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-top: 0; }
        .login-right ol { padding-left: 20px; margin-bottom: 20px; }
        .login-right li { margin-bottom: 8px; font-size: 0.9rem; }
        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 15px; }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ --- */
        .dashboard { display: grid; grid-template-columns: 250px 1fr; height: 100%; }
        .sidebar { background: #252526; border-right: 1px solid #333; display: flex; flex-direction: column; padding: 10px; box-sizing: border-box; overflow-y: auto; }
        .sidebar h1 { font-size: 1.2rem; color: #fff; margin: 20px 10px; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
        .menu-btn { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; border-radius: 5px; color: #aaa; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .menu-btn:hover { background: #3c3c3c; color: #fff; }
        .menu-btn.active { background: #007acc; color: white; }
        .spacer { flex-grow: 1; min-height: 20px; border-bottom: 1px solid #333; margin-bottom: 10px; }

        .main-content { position: relative; overflow: hidden; height: 100%; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; overflow-y: auto; padding: 30px; box-sizing: border-box; }
        .panel.active { display: block; }

        /* --- CMSãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (40:60) --- */
        .cms-layout { display: flex; height: 100%; gap: 0; }
        .editor-area { width: 40%; overflow-y: auto; padding-right: 20px; height: 100%; box-sizing: border-box; }
        .preview-area { width: 60%; background: #e0e0e0; color: #333; overflow-y: auto; padding: 20px; height: 100%; box-sizing: border-box; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-top: 5px; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #aaa; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .label-row label { margin: 0; }

        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #555; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        .input-white { background-color: #ffffff !important; color: #333 !important; border: 1px solid #ccc !important; font-weight: bold; }
        
        .row-group { display: flex; gap: 10px; }
        .row-group > div { flex: 1; }

        .input-group { display: flex; width: 100%; }
        .input-group input { flex: 1; border-top-right-radius: 0 !important; border-bottom-right-radius: 0 !important; border-right: 0 !important; }
        .input-group select { flex: 1; border-top-left-radius: 0 !important; border-bottom-left-radius: 0 !important; background-color: #e6e6e6 !important; color: #0056b3 !important; cursor: pointer; }

        .editor-lang-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .edit-tab { padding: 8px 15px; background: #333; color: #aaa; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .edit-tab:hover { background: #444; color: #fff; }
        .edit-tab.active { background: #007acc; color: white; }
        
        .lang-input-group { display: none; animation: fadeIn 0.3s; }
        .lang-input-group.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¹ã‚¤ãƒƒãƒ */
        .status-switch { display: flex; gap: 10px; background: #333; padding: 2px 8px; border-radius: 4px; }
        .status-label { color: #fff; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: normal; margin: 0; }
        .status-label input { width: auto; margin: 0; }

        /* ç”»åƒé¸æŠ (ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º) */
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 10px; font-size: 1rem; font-weight: bold; color: #333; background: #ffffff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        
        .custom-options { 
            position: absolute; display: block; top: 100%; left: 0; right: 0; 
            border: 1px solid #ccc; border-top: 0; background: #fff; 
            transition: all 0.3s; opacity: 0; visibility: hidden; pointer-events: none; z-index: 100; 
            max-height: 400px; overflow-y: auto; border-radius: 0 0 4px 4px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; padding: 10px;
        }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; }
        
        .custom-option { 
            position: relative; display: flex; flex-direction: column; align-items: center; text-align: center;
            padding: 5px; border: 1px solid #eee; border-radius: 4px; cursor: pointer; transition: all 0.2s; color: #333; 
        }
        .custom-option:hover { background-color: #f2f9fc; border-color: #0056b3; color: #0056b3; }
        .option-img { width: 75px; height: 75px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; border: 1px solid #ddd; }
        .option-text { font-size: 0.8rem; font-weight: bold; word-break: break-all; }

        /* --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ --- */
        .preview-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .preview-label { font-size: 0.8rem; color: #666; font-weight: bold; border-bottom: 1px dashed #999; display: block; margin-bottom: 10px; }
        
        .news-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #ccc; }
        .news-date { font-family: 'Roboto', sans-serif; color: #666; width: 100px; font-size: 0.9rem; }
        .news-tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; margin-right: 15px; color: white; width: 110px; text-align: center; }
        .tag-release { background: #0056b3; } .tag-update  { background: #e67e22; } .tag-start   { background: #8e44ad; } .tag-steam   { background: #2c3e50; } .tag-game    { background: #27ae60; }
        .news-link { text-decoration: none; color: #333; font-weight: 500; font-family: 'Noto Serif JP', serif; }

        .preview-split-row { display: flex; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; margin-bottom: 30px; }
        .split-col { flex: 1; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .split-col.left { background: #f0f0f0; border-right: 1px solid #ddd; }
        .split-col.right { background: #e8e8e8; }

        .highlight-card { width: 100%; max-width: 300px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .highlight-img-area { width: 100%; height: 160px; overflow: hidden; background: #eee; position: relative; }
        .highlight-img { width: 100%; height: 100%; object-fit: cover; object-position: center; transition: opacity 0.3s; }
        .highlight-category-badge { position: absolute; bottom: 0; left: 0; color: white; font-size: 0.8rem; padding: 4px 12px; border-top-right-radius: 8px; font-weight: bold; z-index: 2; }
        
        .highlight-card.dimmed { opacity: 0.4; }
        .highlight-content-tight { padding: 5px 0 0 0; text-align: left; }
        .highlight-title-tight { font-family: 'Noto Serif JP', serif; font-size: 1rem; font-weight: 900; color: #333; line-height: 1.5; margin: 0; width: 18em; white-space: normal; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; height: 4.5em; }
        .highlight-meta { font-size: 0.75rem; color: #666; margin-bottom: 2px; font-family: 'Roboto', sans-serif; }

        .coming-soon-overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-size: 1.8rem; font-weight: 900; color: #fff; text-shadow: 2px 2px 0 #000, -1px -1px 0 #000; border: 3px solid #fff; padding: 5px 20px; box-shadow: 3px 3px 0 rgba(0,0,0,0.5); z-index: 10; pointer-events: none; }
        .highlight-img.coming-soon-mode { opacity: 0.5; filter: grayscale(50%); }

        .project-name-badge { position: absolute; bottom: 0; left: 0; z-index: 5; background: #0056b3; color: #fff; font-family: 'Roboto', sans-serif; font-weight: 900; font-size: 0.9rem; padding: 5px 12px; border-top-right-radius: 8px; box-shadow: 2px -2px 5px rgba(0,0,0,0.3); max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .app-desc-content { padding: 8px 10px; text-align: left; }
        .app-desc-text { font-family: 'Noto Serif JP', serif; font-size: 0.9rem; color: #444; line-height: 1.5; width: 20em; height: 6em; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }

        /* è©³ç´°ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ CSS */
        .page-preview { font-family: 'Noto Serif JP', serif; line-height: 1.8; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .page-preview h1 { border-bottom: 3px solid #0056b3; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; font-size: 1.5rem; }
        .page-preview img { max-width: 100%; border-radius: 10px; margin: 20px 0; }
        .preview-news-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .preview-news-section h3 { margin-top: 0; border-bottom: 2px solid #ccc; padding-bottom: 5px; font-size: 1.1rem; }

        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%; }
        .btn-save { background: #27ae60; color: white; }
        .btn-copy { background: #e67e22; color: white; margin-top: 20px; }
        .btn-reload { background: #3498db; color: white; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-container-split">
            <div class="login-left">
                <h2>ğŸš€ KEI Lab Admin</h2>
                <input type="password" id="tokenInput" placeholder="GitHub Token (ghp_...)">
                <button onclick="checkIdentity()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div id="authStatus"></div>
            </div>
            <div class="login-right">
                <h3>ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œæ‰‹é †</h3>
                <ol>
                    <li><a href="https://github.com/settings/tokens" target="_blank" style="color:#007acc; font-weight:bold;">GitHub Tokenè¨­å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹• â†—</a></li>
                    <li> ã‚’é¸æŠ</li>
                    <li>Expirationï¼ˆæœŸé™ï¼‰ã‚’è¨­å®šï¼ˆ90 daysæ¨å¥¨ï¼‰</li>
                    <li><strong></strong> ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ï¼ˆå¿…é ˆï¼‰</li>
                    <li>ä¸€ç•ªä¸‹ã® ã‚’æŠ¼ã—ã¦ã‚³ãƒ”ãƒ¼</li>
                </ol>
                <div class="warning-box">
                    <strong>âš ï¸ è­¦å‘Šï¼š</strong><br>
                    ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ¼æ´©ã—ãŸå ´åˆã¯ã€ç›´ã¡ã«GitHubè¨­å®šãƒšãƒ¼ã‚¸ã§è©²å½“ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ï¼ˆRevokeï¼‰ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
        </div>
    </div>

    <div id="mainWrapper">
        <div class="dashboard">
            <div class="sidebar">
                <h1>ğŸš€ KEI Lab Admin</h1>
                <div class="menu-btn active" onclick="switchPanel('calc')">ğŸ’° åç›Šãƒ»ç§’æ•°è¨ˆç®—</div>
                <div class="menu-btn" onclick="switchPanel('cms')">ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†</div>
                <div class="menu-btn" onclick="switchPanel('projects')">ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</div>
                
                <!-- æ–°è¦è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ç›´æ¥ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="menu-btn" onclick="switchPanel('raw-admin')" style="font-size: 0.8rem; padding-left: 25px;">ğŸ“„ admin_master.js</div>
                <div class="menu-btn" onclick="switchPanel('raw-index')" style="font-size: 0.8rem; padding-left: 25px;">ğŸ“„ index_news.js</div>
                <div class="menu-btn" onclick="switchPanel('raw-catalog')" style="font-size: 0.8rem; padding-left: 25px;">ğŸ“„ apps_catalog.js</div>
                
                <div class="spacer"></div>
                <div class="menu-btn" onclick="switchPanel('users')">ğŸ‘¥ æ¨©é™ç®¡ç†</div>
                <div class="menu-btn" onclick="logout()" style="margin-top:auto; background:#c0392b; color:white;">ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
            </div>

            <div class="main-content">
                <!-- è¨ˆç®—ãƒ‘ãƒãƒ« -->
                <div id="panel-calc" class="panel active">
                    <div class="calc-container">
                        <h2>ğŸ’° ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
                        <div class="calc-grid">
                            <div><label>å‹•ç”»åºƒå‘Šå˜ä¾¡</label><input type="number" id="adPrice" value="1.5" step="0.1"></div>
                            <div><label>é€šè©±åŸä¾¡ (1åˆ†)</label><input type="number" id="callCost" value="3.0" step="0.1"></div>
                        </div>
                        <label>åˆ©ç›Šç‡ <span id="marginDisplay">20%</span></label>
                        <input type="range" id="margin" min="0" max="50" value="20" oninput="document.getElementById('marginDisplay').innerText = this.value + '%'">
                        <button class="btn-calc" onclick="calcSeconds()">è¨ˆç®—ã™ã‚‹</button>
                        <div class="calc-result-box"><div id="calcOutput" class="calc-number">--- ç§’</div></div>
                    </div>
                </div>

                <!-- CMSãƒ‘ãƒãƒ« -->
                <div id="panel-cms" class="panel">
                    <div class="cms-layout">
                        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ (40%) -->
                        <div class="editor-area">
                            <h2>ğŸ“ è¨˜äº‹ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
                            
                            <div class="row-group">
                                <div class="form-group"><label>æ—¥ä»˜</label><input type="text" id="inDate" class="input-white"></div>
                                <div class="form-group">
                                    <label>ã‚«ãƒ†ã‚´ãƒª</label>
                                    <select id="inCategory" class="input-white" onchange="updatePreview()">
                                        <option value="update">æ›´æ–°æƒ…å ±</option>
                                        <option value="release">ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹</option>
                                        <option value="start">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹</option>
                                        <option value="steam">Steamãƒªãƒªãƒ¼ã‚¹</option>
                                        <option value="game">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ </option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (index_photãƒ•ã‚©ãƒ«ãƒ€)</label>
                                <input type="hidden" id="inImage" onchange="updatePreview()">
                                <div class="custom-select-wrapper">
                                    <div class="custom-select">
                                        <div class="custom-select__trigger" onclick="toggleImageSelect()"><span id="selectedImageText">ç”»åƒã‚’é¸æŠ...</span><span>â–¼</span></div>
                                        <div class="custom-options" id="imageOptions"></div>
                                    </div>
                                </div>
                            </div>

                            <hr style="border:0; border-top:1px dashed #555; margin: 20px 0;">

                            <div class="editor-lang-tabs">
                                <button class="edit-tab active" onclick="switchEditorLang('ja')">ğŸ‡¯ğŸ‡µ JP</button>
                                <button class="edit-tab" onclick="switchEditorLang('en')">ğŸ‡ºğŸ‡¸ EN</button>
                                <button class="edit-tab" onclick="switchEditorLang('de')">ğŸ‡©ğŸ‡ª DE</button>
                                <button class="edit-tab" onclick="switchEditorLang('fr')">ğŸ‡«ğŸ‡· FR</button>
                                <button class="edit-tab" onclick="switchEditorLang('es')">ğŸ‡ªğŸ‡¸ ES</button>
                            </div>

                            <!-- æ—¥æœ¬èª -->
                            <div id="group-ja" class="lang-input-group active">
                                <div class="form-group">
                                    <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå (JP)ã€€admin_master.js</label>
                                    <div class="input-group">
                                        <input type="text" id="inProject" class="input-white" oninput="autoFillProject()">
                                        <select id="projectSelectHelper" class="input-white" onchange="syncProjectSelect()"><option value="">â–¼ å±¥æ­´...</option></select>
                                    </div>
                                </div>
                                <div class="form-group"><label>ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ (JP)</label><textarea id="inTitle" class="input-white" rows="2" oninput="updatePreview()"></textarea></div>
                                
                                <div class="form-group">
                                    <div class="label-row">
                                        <label>ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ (JP)</label>
                                        <div class="status-switch">
                                            <!-- ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ Coming Soon ã«å¤‰æ›´ -->
                                            <label class="status-label"><input type="radio" name="appStatus" value="released" onchange="updatePreview()"> ãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿</label>
                                            <label class="status-label"><input type="radio" name="appStatus" value="coming" checked onchange="updatePreview()"> Coming Soon</label>
                                        </div>
                                    </div>
                                    <textarea id="inBody" class="input-white" rows="3" oninput="updatePreview()"></textarea>
                                </div>
                            </div>

                            <!-- å¤šè¨€èª -->
                            <div id="group-en" class="lang-input-group"><div class="form-group"><label>Project (EN)</label><input type="text" id="inProjectEn" class="input-white" oninput="updatePreview()"></div><div class="form-group"><label>Title (EN)</label><textarea id="inTitleEn" class="input-white" rows="2" oninput="updatePreview()"></textarea></div><div class="form-group"><label>App Intro (EN)</label><textarea id="inBodyEn" class="input-white" rows="3" oninput="updatePreview()"></textarea></div></div>
                            <div id="group-de" class="lang-input-group"><div class="form-group"><label>Project (DE)</label><input type="text" id="inProjectDe" class="input-white" oninput="updatePreview()"></div><div class="form-group"><label>Title (DE)</label><textarea id="inTitleDe" class="input-white" rows="2" oninput="updatePreview()"></textarea></div><div class="form-group"><label>App Intro (DE)</label><textarea id="inBodyDe" class="input-white" rows="3" oninput="updatePreview()"></textarea></div></div>
                            <div id="group-fr" class="lang-input-group"><div class="form-group"><label>Project (FR)</label><input type="text" id="inProjectFr" class="input-white" oninput="updatePreview()"></div><div class="form-group"><label>Title (FR)</label><textarea id="inTitleFr" class="input-white" rows="2" oninput="updatePreview()"></textarea></div><div class="form-group"><label>App Intro (FR)</label><textarea id="inBodyFr" class="input-white" rows="3" oninput="updatePreview()"></textarea></div></div>
                            <div id="group-es" class="lang-input-group"><div class="form-group"><label>Project (ES)</label><input type="text" id="inProjectEs" class="input-white" oninput="updatePreview()"></div><div class="form-group"><label>Title (ES)</label><textarea id="inTitleEs" class="input-white" rows="2" oninput="updatePreview()"></textarea></div><div class="form-group"><label>App Intro (ES)</label><textarea id="inBodyEs" class="input-white" rows="3" oninput="updatePreview()"></textarea></div></div>

                            <!-- ä¿®æ­£: ä¸€æ™‚ä¿å­˜ãƒœã‚¿ãƒ³ã‚’å»ƒæ­¢ã—ã€GitHubæ›´æ–°ä¿å­˜ã®ã¿ã« -->
                            <button class="btn-copy" onclick="saveToGitHub()">ğŸš€ GitHubã¸æ›´æ–°ä¿å­˜</button>
                        </div>

                        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (60%) -->
                        <div class="preview-area">
                            <div class="preview-header">
                                <h2 style="border:none; margin:0; font-size:1.1rem; color:#333;">ğŸ‘ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                            </div>
                            
                            <div style="margin-bottom:30px;">
                                <span class="preview-label">â–¼ ãŠçŸ¥ã‚‰ã› (News List)</span>
                                <div class="news-item">
                                    <span class="news-date" id="prevDate">2026.03.15</span>
                                    <span class="news-tag tag-update" id="prevTag">æ›´æ–°æƒ…å ±</span>
                                    <div style="flex:1;">
                                        <span style="font-weight:bold; margin-right:10px; color:#333;" id="prevProjectName">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                        <span class="news-link" id="prevTitle">ã‚¿ã‚¤ãƒˆãƒ«</span>
                                    </div>
                                </div>
                            </div>

                            <div class="preview-split-row">
                                <div class="split-col left">
                                    <span class="preview-label" style="margin-bottom:10px;">â–¼ æœ€æ–°ã®æ´»å‹• (Highlights)</span>
                                    <div class="highlight-card" id="prevHighlightCard">
                                        <div class="highlight-img-area">
                                            <img src="" alt="No Image" id="prevImg" class="highlight-img">
                                            <span class="highlight-category-badge tag-update" id="prevCardCatBadge">æ›´æ–°æƒ…å ±</span>
                                        </div>
                                        <div class="highlight-content-tight">
                                            <div class="highlight-meta" style="padding:0 10px;">
                                                <span class="meta-date" id="prevCardDate">2026.03.15</span> | 
                                                <span class="meta-proj" id="prevCardProj">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</span>
                                            </div>
                                            <div class="highlight-title-tight" id="prevCardTitle" style="padding:0 10px 10px 10px;">ãŠçŸ¥ã‚‰ã›ãƒ»ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="split-col right">
                                    <span class="preview-label" style="margin-bottom:10px;">â–¼ ã‚¢ãƒ—ãƒªç´¹ä»‹ (App List)</span>
                                    <div class="highlight-card">
                                        <div class="highlight-img-area">
                                            <img src="" alt="No Image" id="prevAppImg" class="highlight-img">
                                            <div id="comingSoonOverlay" class="coming-soon-overlay">Coming Soon</div>
                                            <div class="project-name-badge" id="prevAppProj">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</div>
                                        </div>
                                        <div class="app-desc-content">
                                            <div class="app-desc-text" id="prevAppDesc">ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ãŒã“ã“ã«å…¥ã‚Šã¾ã™...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <span class="preview-label">â–¼ è©³ç´°ãƒšãƒ¼ã‚¸ (Project Page)</span>
                            <!-- æ—¢å­˜ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆ (iframe) -->
                            <div id="realPagePreview" style="display:none; width:100%; height:500px; border:1px solid #ccc; background:#fff;">
                                <div style="background:#333; color:#fff; padding:5px; font-size:0.8rem;">ğŸŒ æ—¢å­˜ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºä¸­ (index.html)</div>
                                <iframe id="prevIframe" style="width:100%; height:calc(100% - 25px); border:none;"></iframe>
                            </div>
                            
                            <!-- æ–°è¦ä½œæˆæ™‚ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
                            <div id="simulatedPagePreview" class="page-preview">
                                <h1 id="prevPageTitle">ã‚¿ã‚¤ãƒˆãƒ«</h1>
                                <div style="color:#666; font-size:0.9rem; margin-bottom:20px;">
                                    <span id="prevPageDate"></span> | <span id="prevPageProject"></span>
                                </div>
                                <img src="" id="prevPageImg" style="display:none; max-width: 100%; border-radius: 10px; margin: 20px 0;">
                                
                                <!-- ä¿®æ­£: ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡ -->
                                <div id="prevAppIntroBody" style="margin-bottom: 30px; line-height: 1.8;"></div>
                                
                                <!-- ä¿®æ­£: news.jsã®è¡¨ç¤ºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ -->
                                <div class="preview-news-section">
                                    <h3>æœ€æ–°ã®æ›´æ–°æƒ…å ± (news.js)</h3>
                                    <ul id="prevNewsListSim" style="list-style: none; padding: 0; margin: 0;">
                                        <!-- JSã§è¿½åŠ  -->
                                    </ul>
                                </div>
                                
                                <!-- ä¿®æ­£: ã™ã¹ã¦ã®å±¥æ­´ã¸ã®ãƒªãƒ³ã‚¯ -->
                                <div style="text-align: right;">
                                    <a href="#" style="color: #0056b3; font-weight: bold; text-decoration: none;">ã™ã¹ã¦ã®æ›´æ–°å±¥æ­´ã‚’è¦‹ã‚‹ã€‚(old_news.js)</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel-projects" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ“‚ å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±</h2>
                        <p>ã“ã“ã§ç™»éŒ²ã•ã‚ŒãŸã‚¢ãƒ—ãƒªä¸€è¦§ï¼ˆapps_catalog.jsï¼‰ã‚’ç®¡ç†ã—ã¾ã™ï¼ˆå®Ÿè£…æº–å‚™ä¸­ï¼‰</p>
                    </div>
                </div>
                
                <!-- æ–°è¦è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ç›´æ¥ç·¨é›†ãƒ‘ãƒãƒ« -->
                <div id="panel-raw-admin" class="panel">
                    <div class="calc-container" style="max-width: 900px;">
                        <h2>ğŸ“„ admin_master.js ç›´æ¥ç·¨é›†</h2>
                        <textarea id="rawAdminText" style="height: 400px; font-family: monospace; font-size: 13px; white-space: pre;"></textarea>
                        <button class="btn-copy" onclick="saveRawFile('admin_master.js', 'rawAdminText')">ğŸš€ GitHubã¸ä¸Šæ›¸ãä¿å­˜</button>
                    </div>
                </div>
                <div id="panel-raw-index" class="panel">
                    <div class="calc-container" style="max-width: 900px;">
                        <h2>ğŸ“„ index_news.js ç›´æ¥ç·¨é›†</h2>
                        <textarea id="rawIndexText" style="height: 400px; font-family: monospace; font-size: 13px; white-space: pre;"></textarea>
                        <button class="btn-copy" onclick="saveRawFile('index_news.js', 'rawIndexText')">ğŸš€ GitHubã¸ä¸Šæ›¸ãä¿å­˜</button>
                    </div>
                </div>
                <div id="panel-raw-catalog" class="panel">
                    <div class="calc-container" style="max-width: 900px;">
                        <h2>ğŸ“„ apps_catalog.js ç›´æ¥ç·¨é›†</h2>
                        <textarea id="rawCatalogText" style="height: 400px; font-family: monospace; font-size: 13px; white-space: pre;"></textarea>
                        <button class="btn-copy" onclick="saveRawFile('apps_catalog.js', 'rawCatalogText')">ğŸš€ GitHubã¸ä¸Šæ›¸ãä¿å­˜</button>
                    </div>
                </div>
                
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ« -->
                <div id="panel-users" class="panel">
                    <div class="calc-container">
                        <h2>ğŸ‘¥ ç·¨é›†æ¨©é™è€…ã®ç®¡ç†</h2>
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <input type="text" id="newUserId" placeholder="GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼ID" class="input-white" style="flex:1;">
                            <button class="btn-save" style="width:auto; margin-top:0;" onclick="addUser()">è¿½åŠ </button>
                        </div>
                        <ul id="userList" style="background:#1e1e1e; padding:20px; border-radius:8px; list-style:none; max-height:300px; overflow-y:auto; border:1px solid #444;"></ul>
                        <button class="btn-copy" onclick="saveUsersToGitHub()">ğŸ’¾ æ¨©é™è¨­å®šã‚’GitHubã«ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_CONFIG = { owner: "KeiAppLab", repo: "KeiAppLab" };
        let previewLang = 'ja';
        let currentProjectId = "";

        // --- èªè¨¼ ---
        async function checkIdentity() {
            const token = document.getElementById('tokenInput').value.trim() || arguments;
            const status = document.getElementById('authStatus');
            if (!token) { status.innerText = "âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›"; status.style.color = "orange"; return; }
            status.innerText = "ç¢ºèªä¸­..."; status.style.color = "black";
            try {
                const res = await fetch("https://api.github.com/user", { headers: { Authorization: `token ${token}` } });
                if (!res.ok) throw new Error("ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³");
                const user = await res.json();
                if (typeof allowedUsersData !== 'undefined' && allowedUsersData.includes(user.login)) {
                    localStorage.setItem('gh_token', token);
                    showDashboard();
                } else { status.innerText = "âŒ æœªè¨±å¯ID: " + user.login; status.style.color = "red"; }
            } catch (err) { status.innerText = "âš ï¸ " + err.message; status.style.color = "red"; }
        }

        function showDashboard() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainWrapper').style.display = 'block';
            updatePreview();
            initProjectList();
            initImageSelector();
        }
        function logout() { localStorage.removeItem('gh_token'); location.reload(); }
        window.addEventListener('load', () => {
            const t = localStorage.getItem('gh_token'); if(t) checkIdentity(t); renderUserList();
        });

        // --- ãƒ‘ãƒãƒ«åˆ¶å¾¡ ---
        function switchPanel(id) {
            document.querySelectorAll('.panel').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            event.currentTarget.classList.add('active');

            // ç›´æ¥ç·¨é›†ãƒ‘ãƒãƒ«ãŒé–‹ã‹ã‚ŒãŸæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒã—ã¦ã‚»ãƒƒãƒˆ
            if(id === 'raw-admin') loadRawFile('admin_master.js', 'rawAdminText');
            if(id === 'raw-index') loadRawFile('index_news.js', 'rawIndexText');
            if(id === 'raw-catalog') loadRawFile('apps_catalog.js', 'rawCatalogText');
        }

        // --- CMSåŸºæœ¬ ---
        const today = new Date();
        document.getElementById('inDate').value = today.getFullYear() + '.' + (today.getMonth()+1).toString().padStart(2,'0') + '.' + today.getDate().toString().padStart(2,'0');

        function switchEditorLang(lang) {
            document.querySelectorAll('.lang-input-group').forEach(e => e.classList.remove('active'));
            document.getElementById('group-' + lang).classList.add('active');
            document.querySelectorAll('.edit-tab').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            previewLang = lang; updatePreview();
        }

        // --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¥åŠ› ---
        function initProjectList() {
            if (typeof adminMasterData === 'undefined') return;
            const sel = document.getElementById('projectSelectHelper');
            sel.innerHTML = '<option value="">â–¼ å±¥æ­´...</option>';
            adminMasterData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.project_id; 
                option.textContent = item.project_ja || item.project_id;
                sel.appendChild(option);
            });
        }

        function syncProjectSelect() {
            const sel = document.getElementById('projectSelectHelper');
            const pid = sel.value;
            if(pid){ 
                const item = adminMasterData.find(d => d.project_id === pid);
                if(item) fillForm(item);
                sel.selectedIndex=0; 
            }
        }

        function fillForm(data) {
            const langs =;
            langs.forEach(lang => {
                const suffix = lang === 'ja' ? '' : lang.charAt(0).toUpperCase() + lang.slice(1);
                document.getElementById('inProject' + suffix).value = data || "";
                document.getElementById('inTitle' + suffix).value = data || "";
                document.getElementById('inBody' + suffix).value = data || "";
            });
            setImageValue(data.image || "");
            if (data.status) {
                const radio = document.querySelector(`input`);
                if(radio) radio.checked = true;
            }
            currentProjectId = data.project_id;
            updatePreview();
            checkProjectImages(data.project_id);
            checkProjectUrl(data.project_id);
        }

        // è‹±èªåå…¥åŠ›ã§IDç”Ÿæˆ
        document.getElementById('inProjectEn').addEventListener('input', async function() {
            const enName = this.value.trim();
            if (enName) {
                currentProjectId = enName.replace(/\s+/g, '_').toLowerCase();
                await checkProjectImages(currentProjectId);
                checkProjectUrl(currentProjectId);
            }
            updatePreview();
        });

        // --- ç”»åƒå‡¦ç† ---
        async function checkProjectImages(projectId) {
            const token = localStorage.getItem('gh_token');
            if (!token) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${projectId}`, {
                    headers: { Authorization: `token ${token}` }
                });
                if (res.ok) {
                    const files = await res.json();
                    const pngs = files.filter(f => f.name.endsWith('.png')).map(f => f.name);
                    if (pngs.length > 0) { renderImageSelector(pngs, projectId + "/"); return; }
                }
            } catch (e) { }
            initImageSelector(); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }

        function initImageSelector() {
            const list = (typeof photoList !== 'undefined') ? photoList :;
            renderImageSelector(list, "index_phot/");
        }

        function renderImageSelector(list, basePath) {
            const c = document.getElementById('imageOptions'); c.innerHTML='';
            list.forEach(n => {
                const d=document.createElement('div'); d.className='custom-option';
                const fullPath = basePath + n;
                d.onclick=()=>{ selectImage(fullPath, n) }; 
                d.innerHTML=`<img src="${fullPath}" class="option-img"><span class="option-text">${n}</span>`;
                c.appendChild(d);
            });
        }

        function toggleImageSelect(){ document.querySelector('.custom-select').classList.toggle('open'); }
        function selectImage(p, n){ document.getElementById('inImage').value = p; document.getElementById('selectedImageText').textContent = n; document.querySelector('.custom-select').classList.remove('open'); updatePreview(); }
        function setImageValue(p){ document.getElementById('inImage').value=p; document.getElementById('selectedImageText').textContent=p.split('/').pop()||"ç”»åƒã‚’é¸æŠ..."; }
        window.onclick=e=>{ if(!e.target.closest('.custom-select')) document.querySelector('.custom-select').classList.remove('open'); }

        // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---
        function checkProjectUrl(projectId) {
            const exists = typeof adminMasterData !== 'undefined' && adminMasterData.some(d => d.project_id === projectId);
            const iframe = document.getElementById('prevIframe');
            const real = document.getElementById('realPagePreview');
            const sim = document.getElementById('simulatedPagePreview');
            
            if (exists) {
                real.style.display = 'block'; sim.style.display = 'none';
                iframe.src = `https://${GITHUB_CONFIG.owner.toLowerCase()}.github.io/${GITHUB_CONFIG.repo}/${projectId}/index.html`;
            } else {
                real.style.display = 'none'; sim.style.display = 'block';
            }
        }

        function updatePreview() {
            const date = document.getElementById('inDate').value;
            const cat = document.getElementById('inCategory').value;
            const img = document.getElementById('inImage').value;
            const s = previewLang==='ja'?'':previewLang.charAt(0).toUpperCase()+previewLang.slice(1);
            
            const proj = document.getElementById('inProject'+s).value || "Project";
            const title = document.getElementById('inTitle'+s).value || "Title";
            const body = document.getElementById('inBody'+s).value || "App Intro...";
            const isComing = document.querySelector('input:checked').value === 'coming';

            // 1. ãŠçŸ¥ã‚‰ã›
            document.getElementById('prevDate').textContent=date;
            document.getElementById('prevTitle').textContent=title;
            document.getElementById('prevProjectName').textContent=proj;
            const tag = document.getElementById('prevTag');
            tag.className='news-tag tag-'+cat; tag.textContent=cat;

            // ç”»åƒ
            const setImg = (id) => { const el = document.getElementById(id); el.src=img; el.style.display=img?'block':'none'; };
            setImg('prevImg'); setImg('prevAppImg'); setImg('prevPageImg');

            // 2. ã‚«ãƒ¼ãƒ‰1 (Highlights)
            document.getElementById('prevCardTitle').textContent=title;
            document.getElementById('prevCardProj').textContent=proj;
            document.getElementById('prevCardDate').textContent=date;
            const badge = document.getElementById('prevCardCatBadge');
            badge.textContent=cat; badge.className='highlight-category-badge tag-'+cat;

            // 3. ã‚«ãƒ¼ãƒ‰2 (App List)
            document.getElementById('prevAppProj').textContent=proj;
            document.getElementById('prevAppDesc').textContent=body;
            const appImg = document.getElementById('prevAppImg');
            const ov = document.getElementById('comingSoonOverlay');
            if(isComing){ appImg.classList.add('coming-soon-mode'); ov.style.display='block'; } else { appImg.classList.remove('coming-soon-mode'); ov.style.display='none'; }

            // 4. è©³ç´°ãƒšãƒ¼ã‚¸ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
            document.getElementById('prevPageTitle').textContent=title;
            document.getElementById('prevPageDate').textContent=date;
            document.getElementById('prevPageProject').textContent=proj;
            // ã‚¢ãƒ—ãƒªç´¹ä»‹æœ¬æ–‡
            document.getElementById('prevAppIntroBody').innerHTML=body.replace(/\n/g, '<br>');
            
            // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆç”Ÿæˆ
            const catNames = {'update':'æ›´æ–°æƒ…å ±', 'release':'ãƒ—ãƒ¬ã‚¹ãƒªãƒªãƒ¼ã‚¹', 'start':'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹', 'steam':'Steamãƒªãƒªãƒ¼ã‚¹', 'game':'ãƒŸãƒ‹ã‚²ãƒ¼ãƒ '};
            const dispCat = catNames || cat;
            document.getElementById('prevNewsListSim').innerHTML = `
                <li style="margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px;">
                    <span style="color: #888; font-size: 0.8rem; margin-right: 10px;">${date}</span>
                    <span style="background: #0056b3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 10px;">${dispCat}</span>
                    <b>${title}</b>
                </li>
            `;
        }

        // --- â˜…ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function saveToGitHub() {
            const token = localStorage.getItem("gh_token");
            if (!token) { alert("èªè¨¼ãŒå¿…è¦ã§ã™"); return; }

            const projectEn = document.getElementById('inProjectEn').value.trim();
            if (!projectEn) { alert("âš ï¸ è‹±èªã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆIDç”Ÿæˆã«å¿…é ˆã§ã™ï¼‰"); return; }
            const projectId = projectEn.replace(/\s+/g, '_').toLowerCase();
            
            if(!confirm(`ID: ${projectId}\nã§ä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

            const inputData = getInputData(projectId);

            try {
                // 1. admin_master.js (ä¸Šæ›¸ã)
                let newMaster = (typeof adminMasterData !== 'undefined') ? :[];
                const idx = newMaster.findIndex(d => d.project_id === projectId);
                if(idx >= 0) newMaster = inputData.master; else newMaster.push(inputData.master);
                await writeJsFile('admin_master.js', newMaster, "Update admin_master");

                // 2. index_news.js (è¿½è¨˜ï¼†ãƒ•ã‚£ãƒ«ã‚¿)
                let indexNews = (typeof indexNewsData !== 'undefined') ? :[];
                indexNews.unshift(inputData.indexItem);
                const releases = indexNews.filter(i =>.includes(i.category)).slice(0, 10);
                const updates = indexNews.filter(i =>.includes(i.category)).slice(0, 10);
                await writeJsFile('index_news.js',, "Update index_news");

                // 3. apps_catalog.js (ä¸Šæ›¸ã)
                let catalog = (typeof appsCatalogData !== 'undefined') ? :[];
                const cIdx = catalog.findIndex(d => d.project_id === projectId);
                if(cIdx >= 0) catalog = inputData.catalogItem; else catalog.push(inputData.catalogItem);
                await writeJsFile('apps_catalog.js', catalog, "Update apps_catalog");

                // 4./news.js (å€‹åˆ¥æœ€æ–°3ä»¶)
                const newsPath = `${projectId}/news.js`;
                let appNews = await fetchExistingJs(newsPath) ||[];
                appNews.unshift(inputData.newsItem);
                await writeJsFile(newsPath, appNews.slice(0, 3), `Update ${projectId} news`);

                // 5./old_news.js (ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–)
                const oldNewsPath = `${projectId}/old_news.js`;
                let oldNews = await fetchExistingJs(oldNewsPath) ||[];
                oldNews.unshift(inputData.newsItem);
                await writeJsFile(oldNewsPath, oldNews, `Update ${projectId} archive`);

                // 6. ç”»åƒã¨HTML
                if (inputData.master.image.startsWith('index_phot/')) {
                    await copyImageToProject(inputData.master.image, `${projectId}/index.png`);
                }
                
                // ä¿®æ­£: HTMLç”Ÿæˆé–¢æ•°ã« inputData ã‚’æ¸¡ã—ã¦ãƒªãƒƒãƒãªãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹
                await createProjectHtml(projectId, inputData);

                alert("âœ… å…¨ã¦ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                location.reload();

            } catch (err) { alert("âŒ ã‚¨ãƒ©ãƒ¼: " + err.message); console.error(err); }
        }

        function getInputData(pid) {
            const date = document.getElementById('inDate').value;
            const cat = document.getElementById('inCategory').value;
            const img = document.getElementById('inImage').value;
            const status = document.querySelector('input:checked').value;
            
            const langs =;
            let names={}, titles={}, bodies={};
            langs.forEach(l => {
                const s = l==='ja'?'':l.charAt(0).toUpperCase()+l.slice(1);
                names = document.getElementById('inProject'+s).value;
                titles = document.getElementById('inTitle'+s).value;
                bodies = document.getElementById('inBody'+s).value;
            });

            // ãƒã‚¹ã‚¿(å…¨éƒ¨å…¥ã‚Š)
            const master = { project_id: pid, date, category: cat, image: img, status, ...names, ...titles, ...bodies };
            // Index(ãŠçŸ¥ã‚‰ã›é‡è¦–)
            const indexItem = { id: Date.now(), date, category: cat, image: `${pid}/index.png`, link: `${pid}/index.html`, ...names, ...titles };
            // Catalog(ç´¹ä»‹æ–‡é‡è¦–)
            const catalogItem = { project_id: pid, status, image: `${pid}/index.png`, ...names, ...bodies };
            // News(ãŠçŸ¥ã‚‰ã›ã®ã¿)
            const newsItem = { date, category: cat, ...titles };

            return { master, indexItem, catalogItem, newsItem };
        }

        async function writeJsFile(path, dataObj, msg) {
            const token = localStorage.getItem("gh_token");
            let sha = null;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, { headers: { Authorization: `token ${token}` } });
                if(res.ok) sha = (await res.json()).sha;
            } catch(e){}

            // å¤‰æ•°ååˆ¤å®šï¼ˆé †ç•ªé‡è¦ï¼‰
            let varName = "data";
            if(path.includes("admin_master")) varName = "adminMasterData";
            else if(path.includes("index_news")) varName = "indexNewsData";
            else if(path.includes("apps_catalog")) varName = "appsCatalogData";
            else if(path.includes("old_news")) varName = "oldNewsData"; // å…ˆã«åˆ¤å®š
            else if(path.includes("news")) varName = "newsData";

            const content = `const ${varName} = ${JSON.stringify(dataObj, null, 4)};`;
            const encoded = btoa(unescape(encodeURIComponent(content)));

            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: msg, content: encoded, sha: sha })
            });
            if (!res.ok) throw new Error(`Failed to write ${path}`);
        }

        async function fetchExistingJs(path) {
            const token = localStorage.getItem("gh_token");
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, { headers: { Authorization: `token ${token}` } });
                if (!res.ok) return null;
                const json = await res.json();
                const content = decodeURIComponent(escape(atob(json.content)));
                const match = content.match(/\/s);
                if (match) return JSON.parse(match);
            } catch (e) { }
            return null;
        }

        async function copyImageToProject(src, dest) {
            const token = localStorage.getItem("gh_token");
            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${src}`, { headers: { Authorization: `token ${token}` } });
            if(!res.ok) return;
            const data = await res.json();
            
            let sha = null;
            try {
                const check = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${dest}`, { headers: { Authorization: `token ${token}` } });
                if(check.ok) sha = (await check.json()).sha;
            } catch(e){}

            await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${dest}`, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: "Copy image", content: data.content, sha: sha })
            });
        }

        // ä¿®æ­£: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜è¦‹ãŸç›®ã®HTMLã‚’ç”Ÿæˆã™ã‚‹
        async function createProjectHtml(pid, inputData) {
            const path = `${pid}/index.html`;
            const token = localStorage.getItem("gh_token");
            const check = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, { headers: { Authorization: `token ${token}` } });
            if(check.ok) return;

            const m = inputData.master;
            const title = m.title_ja || m.title_en || "Title";
            const proj = m.project_ja || m.project_en || pid;
            const body = (m.body_ja || m.body_en || "").replace(/\n/g, '<br>');

            // è‡ªå‹•ç”ŸæˆHTML (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
            // â€» </script> ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ¸ˆã¿
            const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${proj}</title>
    <!-- å€‹åˆ¥ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ -->
    <script src="news.js"><\/script>
    <style>
        body { font-family: 'Noto Serif JP', sans-serif; padding: 20px; background: #fff; color: #333; line-height: 1.8; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1 { border-bottom: 3px solid #0056b3; display: inline-block; padding-bottom: 5px; margin-bottom: 20px; font-size: 1.5rem; }
        .meta { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        .hero-img { max-width: 100%; border-radius: 10px; margin: 20px 0; }
        .intro-body { margin-bottom: 30px; }
        .news-section { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .news-section h3 { margin-top: 0; border-bottom: 2px solid #ccc; padding-bottom: 5px; font-size: 1.1rem; }
        .news-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #ddd; }
        .news-date { color: #888; font-size: 0.8rem; margin-right: 10px; }
        .news-cat { background: #0056b3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 10px; }
        .all-news-link { display: block; text-align: right; color: #0056b3; font-weight: bold; text-decoration: none; }
    </style>
</head>
<body>
    <h1 id="page-title">${title}</h1>
    <div class="meta"><span id="page-date">${m.date}</span> | <span id="page-project">${proj}</span></div>
    
    <img src="index.png" class="hero-img" alt="Hero Image" onerror="this.style.display='none'">
    
    <div id="app-intro" class="intro-body">${body}</div>

    <div class="news-section">
        <h3>æœ€æ–°ã®æ›´æ–°æƒ…å ±</h3>
        <div id="news-container"></div>
    </div>
    
    <a href="old_news.js" class="all-news-link">ã™ã¹ã¦ã®æ›´æ–°å±¥æ­´ã‚’è¦‹ã‚‹ã€‚(old_news.js)</a>

    <script>
        const container = document.getElementById('news-container');
        if(typeof newsData !== 'undefined' && newsData.length > 0){
            newsData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'news-item';
                div.innerHTML = '<span class="news-date">' + item.date + '</span><span class="news-cat">' + item.category + '</span><b>' + (item.title_ja || item.title_en) + '</b>';
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        }
    <\/script>
</body>
</html>`;
            const encoded = btoa(unescape(encodeURIComponent(html)));
            await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: "Create HP", content: encoded })
            });
        }

        // --- ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ãƒ­ã‚¸ãƒƒã‚¯ ---
        async function loadRawFile(filename, textareaId) {
            const ta = document.getElementById(textareaId);
            ta.value = "èª­ã¿è¾¼ã¿ä¸­...";
            const data = await fetchExistingJs(filename);
            if(data) {
                ta.value = JSON.stringify(data, null, 4);
            } else {
                ta.value = "";
            }
        }

        async function saveRawFile(filename, textareaId) {
            const ta = document.getElementById(textareaId);
            const token = localStorage.getItem("gh_token");
            if (!token) { alert("èªè¨¼ãŒå¿…è¦ã§ã™"); return; }
            
            let parsedData;
            try {
                parsedData = JSON.parse(ta.value);
            } catch(e) {
                alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: " + e.message);
                return;
            }
            
            if(!confirm(`${filename} ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
            
            try {
                await writeJsFile(filename, parsedData, `Direct edit ${filename}`);
                alert(`âœ… ${filename} ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼`);
            } catch(err) {
                alert("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
            }
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»è¨ˆç®— ---
        function renderUserList() {
            const list = document.getElementById('userList'); if(!list) return; list.innerHTML = '';
            if (typeof allowedUsersData !== 'undefined') {
                allowedUsersData.forEach((user, index) => {
                    const li = document.createElement('li');
                    li.style = "display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #444; color:#fff;";
                    li.innerHTML = `<span>${user}</span><button style="background:#c0392b; width:auto; padding:2px 8px; font-size:0.8rem; margin:0;" onclick="removeUser(${index})">å‰Šé™¤</button>`;
                    list.appendChild(li);
                });
            }
        }
        function addUser() {
            const id = document.getElementById('newUserId').value.trim();
            if(!id || allowedUsersData.includes(id)) return;
            allowedUsersData.push(id); document.getElementById('newUserId').value=''; renderUserList();
        }
        function removeUser(i) { if(confirm("å‰Šé™¤?")) { allowedUsersData.splice(i, 1); renderUserList(); } }
        
        async function saveUsersToGitHub() {
            const token = localStorage.getItem("gh_token");
            if (!token) return;
            const content = `const allowedUsersData = ${JSON.stringify(allowedUsersData, null, 4)};`;
            const encoded = btoa(unescape(encodeURIComponent(content)));
            const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/allowed_users.js`, { headers: { Authorization: `token ${token}` } });
            const sha = (await res.json()).sha;
            await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/allowed_users.js`, {
                method: "PUT", headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: "Update users", content: encoded, sha: sha })
            });
            alert("æ¨©é™æ›´æ–°å®Œäº†");
        }

        function calcSeconds() {
            const p = parseFloat(document.getElementById('adPrice').value), c = parseFloat(document.getElementById('callCost').value), m = parseFloat(document.getElementById('margin').value);
            document.getElementById('calcOutput').innerText = Math.floor((p - p*(m/100)) / (c/60)) + " ç§’";
        }
    </script>
</body>
</html>
